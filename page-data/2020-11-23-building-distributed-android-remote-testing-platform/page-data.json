{"componentChunkName":"component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx","path":"/2020-11-23-building-distributed-android-remote-testing-platform/","result":{"data":{"post":{"__typename":"MdxPost","slug":"/2020-11-23-building-distributed-android-remote-testing-platform/","title":"Building a Distributed Android Remote Testing Platform - An Attempt to Make Real GUI Testing Affordable & Comprehensive","date":"23.11.2020","tags":[{"name":"android","slug":"android"},{"name":"testing","slug":"testing"},{"name":"grpc","slug":"grpc"}],"description":null,"canonicalUrl":"https://elvischidera.com/2020-11-23-building-distributed-android-remote-testing-platform/","body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Building a Distributed Android Remote Testing Platform - An Attempt to Make Real GUI Testing Affordable & Comprehensive\",\n  \"date\": \"2020-11-23T00:00:00.000Z\",\n  \"slug\": \"/2020-11-23-building-distributed-android-remote-testing-platform/\",\n  \"canonicalUrl\": \"https://elvischidera.com/2020-11-23-building-distributed-android-remote-testing-platform/\",\n  \"banner\": \"./assets/banner.png\",\n  \"tags\": [\"android\", \"testing\", \"grpc\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"img\", {\n    \"className\": \"fit_image\",\n    \"src\": \"/1ffaeb44c8a342b87f8aea771c98c871/dart_work_flow.svg\"\n  }), mdx(\"p\", null, \"There are currently ~2.5 billion Android devices \\u2014 consisting of ~1,300 discrete brands and ~24,000 unique device models. I'm exploring tapping into this latent resource pool to make automated testing affordable & unlock a more comprehensive configuration coverage.\"), mdx(\"p\", null, \"The goal of DART (Distributed Android Remote Testing) is to enable any Android device to run automated tests \\u2014 without ADB or complex setups/maintenance. A commercial product could pay people per hour of device use, allowing anyone to utilize idle device time. Each device is subsumed to provide a distributed testbed.\"), mdx(\"p\", null, \"DART is orthogonal to \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://en.wikipedia.org/wiki/Crowdsourced_testing\"\n  }), \"crowdsourced testing\"), \" \\u2014 the latter requires active human participation.\"), mdx(\"p\", null, \"DART seems to be the best solution to utilize device idle time \\u2014 the best way to verify that an app works on \\\"Samsung S9\\\" is by executing it on \\\"Samsung S9\\\".  Contrast this to other procedures where phones are usually a suboptimal option: server hosting, remote computation, etc.\"), mdx(\"p\", null, \"In the demo below, I ran a few test cases on \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://play.google.com/store/apps/details?id=org.mozilla.focus&hl=en_US&gl=US\"\n  }), \"Mozilla Focus Privacy Browser\"), \" without cables/ADB.\"), mdx(\"div\", {\n    className: \"video_wrapper\"\n  }, mdx(\"iframe\", {\n    className: \"video_frame\",\n    width: \"100%\",\n    height: \"100%\",\n    src: \"https://www.youtube.com/embed/CcHEsx7ODyw\",\n    frameBorder: \"0\",\n    allow: \"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\",\n    allowFullScreen: true\n  })), mdx(\"h3\", null, \"1.1. \\uD83D\\uDCAA Motivation\"), mdx(\"p\", null, \"The following problems motivated the development of DART.\"), mdx(\"h5\", null, \"i. \\uD83E\\uDDE9 Android Device Fragmentation\"), mdx(\"img\", {\n    \"className\": \"fit_image\",\n    \"src\": \"/4c37a9cd069bcaa8ee86c04764a37790/android_fragmentation.gif\",\n    \"alt\": \"Android device fragmentation\"\n  }), mdx(\"p\", null, \"The top device farms barely cover 1% of the total number of Android device models. Nondistributed device farms favor depth instead of breadth \\u2014 maintenance cost increases as more diverse devices are added.\"), mdx(\"p\", null, \"Testing on flagship devices alone doesn't always suffice.\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"Anecdote: I once spent an entire day debugging an ANR that occurs to a small fraction of our users. I discovered it only affects phones purchased in specific regions. I never was able to reproduce the issue on the same phone bought in the USA.\")), mdx(\"p\", null, \"The Android version distribution exacerbates this problem.\"), mdx(\"p\", null, mdx(\"span\", _extends({\n    parentName: \"p\"\n  }, {\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"960px\"\n    }\n  }), \"\\n      \", mdx(\"a\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/b242c178d4653a1a85fcaaeddfff889a/53fe7/android_os_distribution.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"67.5%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACHklEQVQ4y31T32sTQRDOn+N/oIiFvojY/8GKINpW8VnQ5yK0VJ98kCJI25S+FZX4A+OLiGILxtZISSRtRds0MZe729u9u93b+5y9y4VcmjgwzM3czOw3s98W4jiGkVgH0MpBrBjZVGPlJX4cueS7qR9xUpHmyG5Sl9RTH6OFrKEOmpBOBYrtJSrd71BenWwVrPWF/u1C8TrFaoh4g3J+QFqfEPlH+YaZ8z+JkwlIozH/B+r7CNMTdGq1hHAtOB4HZ22Cr+DTt+3YCHzfJPdyNfL1vZEzNVg0WcYcMOcvRK0EvnsFW4szeH59GQfl7RyqrMaYrHHhFGxCYyT8tgzv6RmIDxdRXX+Ajal5vDh7E43Vt7mGgwj7I2eOL2isThvh4Q7E0gT8d3dp/HRxWip8vfcEbybvwP35p3d4PHqH/ZtWEqY8/LwCvjAB3TowS4C0qxSNwPaP8er8HBobZdjdLpjtDI0/PHKUogner8C5PwVtnVBDH7JToaiAaFp4feEW9tfLSV6kVHpBGLdDww0SWd2GdfsSROlZjh57jzdROjeLTqXeewy9Wx5gXY6HUaThtJoQRA++toDm1ctoP1yC+3ITnUeL+Dg5jZ354kj+5RAO3lRkTjXfMoRdXMXx3Ax+X5vG0ewNWGtFeCcdhEGAMAxP7W80bYD+6Cbi/TqEqNeghUhignN4jIGTHdtwmO0ZYSWhYJ4H1T9Hj31ymfwDPx8k/mrXzcUAAAAASUVORK5CYII=')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  })), \"\\n  \", mdx(\"img\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"Android OS Distribution\",\n    \"title\": \"Android OS Distribution\",\n    \"src\": \"/static/b242c178d4653a1a85fcaaeddfff889a/7d769/android_os_distribution.png\",\n    \"srcSet\": [\"/static/b242c178d4653a1a85fcaaeddfff889a/5243c/android_os_distribution.png 240w\", \"/static/b242c178d4653a1a85fcaaeddfff889a/ab158/android_os_distribution.png 480w\", \"/static/b242c178d4653a1a85fcaaeddfff889a/7d769/android_os_distribution.png 960w\", \"/static/b242c178d4653a1a85fcaaeddfff889a/87339/android_os_distribution.png 1440w\", \"/static/b242c178d4653a1a85fcaaeddfff889a/88b03/android_os_distribution.png 1920w\", \"/static/b242c178d4653a1a85fcaaeddfff889a/53fe7/android_os_distribution.png 2097w\"],\n    \"sizes\": \"(max-width: 960px) 100vw, 960px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  })), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://www.headspin.io/\"\n  }), \"Headspin\"), \" aims to alleviate some of these issues. They claim to have a global infrastructure of more than 22,000 SIM-enabled (similar) devices in 150 locations. A big plus as traditional services (like Firebase Testlabs) can't handle geographical concerns. At Headspin's core is the \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/DeviceFarmer/stf\"\n  }), \"DeviceFarmer STF\"), \" open-source library. But like its predecessors, Headspin only supports a limited set of device models.\"), mdx(\"h5\", null, \"ii. \\uD83D\\uDCB8 Expensive Physical Devices\"), mdx(\"img\", {\n    \"className\": \"fit_image\",\n    \"src\": \"/457ab6ec0d4f4335573264b78937f40d/real_device_pricing_chart.svg\"\n  }), mdx(\"p\", null, \"Real device test farms have an initial cost and require periodic maintenance, hence why they are more expensive than virtual device farms.\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"Running 10 hours of test daily on real devices costs \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"$1000/month\"), \" (assuming 20 working days of equal levels of productivity).\")), mdx(\"h3\", null, \"1.2. \\uD83D\\uDCF1 Product\"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"The key \\uD83D\\uDD11:\"), \" Uber averts enormous maintenance costs by not owning all the cars on its global network. Similarly, with a distributed network of test devices, extensive device coverage is attainable with minimal maintenance costs. For one or two co-located devices, maintenance isn't fastidious.\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"From \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/DeviceFarmer/stf#faq\"\n  }), \"DeviceFramer STF\"), \" FAQ: \\\"Aside from a single early failure we had within only a few months, all of our devices were doing fine for about two years. However, having reached the 2-3 year mark, several devices have started to experience visibly expanded batteries \", \"[...]\", \"\\nIn our experience, the system runs just fine most of the time, and any issues are mostly USB-related. You'll usually have to do something about once a week.\\\"\")), mdx(\"p\", null, \"Organizations can decide what type of tests are ideal for DART and if the network is made-up of single nodes or clusters of nodes. The simple taxonomy of android testing below should be helpful. \", \"[1]\"), mdx(\"img\", {\n    \"className\": \"full_width_image\",\n    \"src\": \"/3c544343e6de6b0d393c6101c4359694/taxonomy_android_testing.svg\",\n    \"alt\": \"Taxonomy of Android testing\"\n  }), mdx(\"p\", null, \"The network can be internal to an organization. An example: \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"X\"), \" devices stored in HQ, each employee can remotely contribute their test device into the system.\"), mdx(\"p\", null, \"It can also be external to an organization. Imagine paying people \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"$1.5/hour\"), \" of device time. Assuming a device runs test overnight (thanks to timezone differences), the estimated monthly earning is \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"$240\"), \" (\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"$1.5 * 8 hours * 20 working days\"), \").\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"The median income in some countries is ~$400/month. \")), mdx(\"p\", null, \"Below is a demo of the \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/Elvis10ten/dart\"\n  }), \"proof-of-concept\"), \".\"), mdx(\"div\", {\n    className: \"video_wrapper\"\n  }, mdx(\"iframe\", {\n    className: \"video_frame\",\n    width: \"100%\",\n    height: \"100%\",\n    src: \"https://www.youtube.com/embed/7SotlhlwMDA\",\n    frameBorder: \"0\",\n    allow: \"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\",\n    allowFullScreen: true\n  })), mdx(\"p\", null, \"Currently, a simple dashboard renders the test summary.\"), mdx(\"div\", {\n    \"className\": \"image_row\"\n  }, \"\\n  \", mdx(\"div\", _extends({\n    parentName: \"div\"\n  }, {\n    \"className\": \"dual_image_column\"\n  }), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"div\"\n  }, {\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"960px\"\n    }\n  }), \"\\n      \", mdx(\"a\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/df61ab399fe3e586915d07813ac34298/e60a2/dashboard_timeline.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"67.5%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACJklEQVQ4y31Sy44TMRDcn80usAsSyi4c4MxfcIQTP7EK4sqBA1qEACU7ySQzeXhefoztomznLYSlkj097nJVd188efEKV8/vcHlzi8vr27gPng0xuB4eYmcY7DHE1c0dnr58Q47X/DfEhdI9pDIQooWoOqJF0yqEeNMptFKjizDbXcd/KW8HAxXA2IU2Frq3AALS8r1GtRFYi4bkMpKkXcVkwxzDnN66eNZHiISKr/8alfj2ucDDT42HucK8VnCWr5PEec9k3lMKPYmcc1SjoQnn/F5xUsiLsjYYvc3w6V2O9x/W+Pi1xXdBxc7SdgfLRMt7TdNSpYT1Lj4kwwO8E4i0SUgKeRjXBdqujZYlY3JbE60tbO/i5WAxKFQ62Q7fkUjbM0ImehL9GU9wP/rCIvqoSLHg2abEohGo2Kg22LK02BMm2N6ps1vL9kAYVrCUTfN4DkqM8VhXJdbZb+h5AbVYcF9wL6BFBU3Lu/zUlF2XCe89jlfbdpC82NUtyskYy2yCTTbGejaFKBaoliXEahUn4KBwTxgU0maw0rhUx+2IiIYdFxKrWqJuOKdNeMhu0Z9Z7o8te9SFxY97xXOarxCfch7LJg17IGHpOLcuIYg5I90rjDWLdUvnEDNMqioBQct6NoPKc2hChTryIS1Pa3iiUP1DflDRVDWKxwmW00dsZhOs8hlEWUD8r4b7Lp2MQWpWLXvklcKKtaxpO4xPnFOT6ngu4i8R3B3AkLWLHQAAAABJRU5ErkJggg==')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  })), \"\\n  \", mdx(\"img\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"Dashboard timeline\",\n    \"title\": \"Dashboard timeline\",\n    \"src\": \"/static/df61ab399fe3e586915d07813ac34298/7d769/dashboard_timeline.png\",\n    \"srcSet\": [\"/static/df61ab399fe3e586915d07813ac34298/5243c/dashboard_timeline.png 240w\", \"/static/df61ab399fe3e586915d07813ac34298/ab158/dashboard_timeline.png 480w\", \"/static/df61ab399fe3e586915d07813ac34298/7d769/dashboard_timeline.png 960w\", \"/static/df61ab399fe3e586915d07813ac34298/87339/dashboard_timeline.png 1440w\", \"/static/df61ab399fe3e586915d07813ac34298/88b03/dashboard_timeline.png 1920w\", \"/static/df61ab399fe3e586915d07813ac34298/e60a2/dashboard_timeline.png 3086w\"],\n    \"sizes\": \"(max-width: 960px) 100vw, 960px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  })), \"\\n  \"), \"\\n    \"), \"\\n  \"), \"\\n  \", mdx(\"div\", _extends({\n    parentName: \"div\"\n  }, {\n    \"className\": \"dual_image_column\"\n  }), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"div\"\n  }, {\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"960px\"\n    }\n  }), \"\\n      \", mdx(\"a\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/adbbe95cc9f013049dcec4967d3c551b/e60a2/dashboard_screenshots.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"67.5%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACbklEQVQ4y41SW0tUURT2ZwS9RX+g53wyiCDCCCOYJCjT0byEzqTH0ZcMxcRoUEQoepCKEiNDCUeKZBrHMBu8TeiYmpdGszNUZ87M7H0uc7723sfLTFm5OB/rO3vv9e219lo5pVW1cFbeQEmFGyXlbuGLr7lQXO6y/TaucpTVZKGotEbElFU3oKLaAyeLyaGaAUJ1KEoSSjzFkISapODrpgWYgO0Z2CeQxp7xdUI0ocFjcjTdhGaIsN1DlqEhriiIhBfhHw5iIjiFuZkFjPs/YCIwiaX5Fcy8DyM0OoW15SiMtAWhwyAEKdGxHIhhdlRGZJEiskWxpVLUXZSQezgPjtzLuF7gwokjp3Dy6Bm4HfU4e6wAxw/lwdvQJZJIsSztDE0TRNURaIziWctXPHj8HU+nCUIbKgZ7XmB17BPeDgTR7GrH6vgCQr4Q43cw+2YS8yNhDDzxQTfSQmy3ZKobWFNlJFNJcZvOHikm/8RQ32sQJjz1Loy2+k6kNhR8nl1Bq9SB6Nw65KVvGOofgabZ5e4JMsIfe2VtHf7AmBBVfqgYfj4i2vBxeh5tUhdrhonolw201nVClmOIJ+JCkOr7CHJLJJKIRjcFp6xrkrMFV/JdKCv0oOicG6XnJVzKr4bzgoRKRyMKT1eh/dY9cT67ywyWZSHTUoSgt2cQTbV30e19iL5HL9Hi6cDtm93o7x2Gt/k+miQvXvmCorrfBA1RmmlYoAl7ygihOKhxoeyx0WxBVTax4KdidHX20PxWPg4chHCus8bZQyz+t/mORlaGBhtunWOHZxz6H/4Q/Nsmv2inlH9h35LFgpa9mckPil8cV91m8du+1QAAAABJRU5ErkJggg==')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  })), \"\\n  \", mdx(\"img\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"Dashboard screenshots\",\n    \"title\": \"Dashboard screenshots\",\n    \"src\": \"/static/adbbe95cc9f013049dcec4967d3c551b/7d769/dashboard_screenshots.png\",\n    \"srcSet\": [\"/static/adbbe95cc9f013049dcec4967d3c551b/5243c/dashboard_screenshots.png 240w\", \"/static/adbbe95cc9f013049dcec4967d3c551b/ab158/dashboard_screenshots.png 480w\", \"/static/adbbe95cc9f013049dcec4967d3c551b/7d769/dashboard_screenshots.png 960w\", \"/static/adbbe95cc9f013049dcec4967d3c551b/87339/dashboard_screenshots.png 1440w\", \"/static/adbbe95cc9f013049dcec4967d3c551b/88b03/dashboard_screenshots.png 1920w\", \"/static/adbbe95cc9f013049dcec4967d3c551b/e60a2/dashboard_screenshots.png 3086w\"],\n    \"sizes\": \"(max-width: 960px) 100vw, 960px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  })), \"\\n  \"), \"\\n    \"), \"\\n  \")), mdx(\"h3\", null, \"1.3. \\uD83D\\uDEE1\\uFE0F Security\"), mdx(\"p\", null, mdx(\"span\", _extends({\n    parentName: \"p\"\n  }, {\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"960px\"\n    }\n  }), \"\\n      \", mdx(\"a\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/2964435cc8375c02bac5d7ac8e9d9646/9211e/network_of_devices.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"57.50000000000001%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAABvElEQVQoz31T207CQBD1/3/BDzAxPpiY+Gi8ixhFFBGhpS3L/dIi9N7dPc62FFshTjLd6XRu58z2QEoJJem5seM4RpIkqc3pDP0AUmTf/kopn+Sg+BJJgQACxmgMNpshhETLtFAfMhiDIVyewCP1SV0eI6T4Yn5acNtBCNjuGiFNpDyCnupsdDScVR/Ro4LKl1Acl9mp4uMNElVH6bbgcDLF9VcLk/kig8qz7p7no9nRs4QC1PXKxb3WhklolIgccm5YNMHlZxOD8XSHp4B0RBSYX1XMbTv1dXQDp5UH3NfqkPwX+nZCn4g3+gMEYYSEltJhfbT7fTjfKzjEV6vbhf58AkYxSpbk13sMk9m8tJjSUnxknUIvwMXrK85rLxhTglrUau1SwxlcoiCXeM+2y1sW+SoAw+yh+dneNNq5K1ljzncL5sbCcfDc1bFYfpdyl84Sb5UKXN8Hp4Zdi6UtR8R1jVloE2ye8F0On+oNHN3dotr4oPsn4MYRTSaJM4arw0MM7AUi8g8dG57g0Kjw8c0NHt8/ygVzY0TXRtMMTKbzEoQwitCjafI/pyiWyRD4wX7I//1ORX9R98X/ANjZn5HXgozIAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  })), \"\\n  \", mdx(\"img\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"Network of devices\",\n    \"title\": \"Network of devices\",\n    \"src\": \"/static/2964435cc8375c02bac5d7ac8e9d9646/7d769/network_of_devices.png\",\n    \"srcSet\": [\"/static/2964435cc8375c02bac5d7ac8e9d9646/5243c/network_of_devices.png 240w\", \"/static/2964435cc8375c02bac5d7ac8e9d9646/ab158/network_of_devices.png 480w\", \"/static/2964435cc8375c02bac5d7ac8e9d9646/7d769/network_of_devices.png 960w\", \"/static/2964435cc8375c02bac5d7ac8e9d9646/87339/network_of_devices.png 1440w\", \"/static/2964435cc8375c02bac5d7ac8e9d9646/88b03/network_of_devices.png 1920w\", \"/static/2964435cc8375c02bac5d7ac8e9d9646/9211e/network_of_devices.png 1955w\"],\n    \"sizes\": \"(max-width: 960px) 100vw, 960px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  })), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"There are two perspectives here:\"), mdx(\"h5\", null, \"i. \\uD83E\\uDDD0 End-user Perspective\"), mdx(\"p\", null, \"The end-user is concerned about malignant binaries & privacy.\"), mdx(\"p\", null, \"Security checks will guard devices from malicious binaries. The system will be closed \\u2014 only verified publishers allowed. GooglePlay is leveraged to enforce package name and signature correspondence.\"), mdx(\"p\", null, \"A sandboxed test environment guarantees that private data is inaccessible to apps under test.\"), mdx(\"p\", null, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://blog.google/products/android-enterprise/android-enterprise-security-assessed-gartner/\"\n  }), mdx(\"span\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"960px\"\n    }\n  }), \"\\n      \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"40.416666666666664%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIEBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHZiJYC/wD/xAAYEAACAwAAAAAAAAAAAAAAAAAREgACA//aAAgBAQABBQK5XNxP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFxAAAwEAAAAAAAAAAAAAAAAAABAiMf/aAAgBAQAGPwKNLX//xAAYEAADAQEAAAAAAAAAAAAAAAAAAREhQf/aAAgBAQABPyGbxeS2KTMP/9oADAMBAAIAAwAAABAED//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/EIf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAADAAMAAAAAAAAAAAAAAAAAAREhMWH/2gAIAQEAAT8Qd2mWDcHv4zZB/9k=')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  })), \"\\n  \", mdx(\"img\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"Android Enterprise security\",\n    \"title\": \"Android Enterprise security\",\n    \"src\": \"/static/a60424159862b8385fef4219304a1b71/18e3b/android_enterpise_security.jpg\",\n    \"srcSet\": [\"/static/a60424159862b8385fef4219304a1b71/46946/android_enterpise_security.jpg 240w\", \"/static/a60424159862b8385fef4219304a1b71/55489/android_enterpise_security.jpg 480w\", \"/static/a60424159862b8385fef4219304a1b71/18e3b/android_enterpise_security.jpg 960w\", \"/static/a60424159862b8385fef4219304a1b71/dbdff/android_enterpise_security.jpg 1000w\"],\n    \"sizes\": \"(max-width: 960px) 100vw, 960px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  })), \"\\n    \"))), mdx(\"h5\", null, \"ii. \\uD83D\\uDC69\\uD83C\\uDFFD\\u200D\\uD83D\\uDCBB Publisher Perspective\"), mdx(\"p\", null, \"The publisher cares about test fraud and product leaks.\"), mdx(\"p\", null, \"Proof of work disincentivizes test fraud. The server can use device logs, screenshots, videos with UUID, and past executions to validate submitted work results. As this isn't watertight, it is best combined with other strategies: user verifications, \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://developer.android.com/training/safetynet\"\n  }), \"device attestation\"), \", randomization, and device throughput throttling.\"), mdx(\"p\", null, \"Preventing product leaks is hard  \\u2014 if it runs on a phone, any sufficiently motivated (& knowledgeable) person can figure out a way to access objects. Three good-enough solutions are:\"), mdx(\"p\", null, \"a. Running headless tests.\"), mdx(\"p\", null, \"b. Using a private network of vetted devices.\"), mdx(\"p\", null, \"c. Adopting only for binaries at the later end of the release pipeline.\"), mdx(\"h3\", null, \"1.4. \\uD83C\\uDF83 Going Headless\"), mdx(\"p\", null, \"It is possible to obscure the application under test using a simple overlay. The video below shows the execution of the test cases of the Google IO 2019 app. On the right, the app interactions are invisible. Depending on the strategy, concealing actions do not affect screenshots or videos.\"), mdx(\"div\", {\n    className: \"video_wrapper\"\n  }, mdx(\"iframe\", {\n    className: \"video_frame\",\n    width: \"100%\",\n    height: \"100%\",\n    src: \"https://www.youtube.com/embed/jxwsoe3T8yE\",\n    frameBorder: \"0\",\n    allow: \"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\",\n    allowFullScreen: true\n  })), mdx(\"p\", null, \"With framework UI component wrappers, it is possible to borrow some ideas from \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://android.googlesource.com/platform/frameworks/base/+/4db1f432b853152075923499768639e14403b73a/tools/layoutlib/README\"\n  }), \"Layoutlib\"), \" to offer a full headless solution. \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Layoutlib\"), \" is a custom version of the android View framework designed to run inside Eclipse. The goal of the library is to provide layout rendering in Eclipse that are very close to their rendering on devices.\"), mdx(\"h3\", null, \"1.5. \\uD83D\\uDCE6 Containerization\"), mdx(\"p\", null, \"Tests need to run in an isolated environment. A plugin framework like \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/didi/VirtualAPK\"\n  }), \"VirtualAPK\"), \" can be built to offer a layer of isolation between apps and the OS. This works using the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"DexClassLoader\"), \" and some reflection hacks to modify framework components. With this approach, apps can be seamlessly loaded & unloaded without any user interaction.\"), mdx(\"p\", null, mdx(\"span\", _extends({\n    parentName: \"p\"\n  }, {\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"960px\"\n    }\n  }), \"\\n      \", mdx(\"a\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/d9bbe7fecdd50b018b77ea33d7766d4a/56ba3/virtual_apk_diagram.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"56.666666666666664%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAABYlAAAWJQFJUiTwAAACZklEQVQoz2P49+/f////3338OuXAu0kHPk7Y/3HpibczD7+fuP9j//6PC469W3bibd++T5MPfJx44OPa06+nHvwAZPTu+wQUZ/jx4+eP71+fvvkSteZ31Pr/4ev+F279lbTxb8Ta/2Fr/+dt/VW583vg6v/R6/9FrvvfsPu7/4p/viv+uywBKvvOALH57ftPM7ecnbbp9NRNZ1bsuzx327mpG09N2Xhqye6Lq/Zfnrzh9LRNp6ZtPrvh8NVZW87O2Hxq8saTK/dfYvj169ePX38/vXnyaYLY9xlK3yaJvF9g92W27vcZqj+my31caPtukcv3SSLf5uh+nST6dmX41xmq32Zpfp8i9X6pF8Of379//fn3+e2z9/OMvy53+rLQ9N2qkI+L7b4sc/q62OL9Sr+3a6O+zNP/ssrr8zz9N5uzPi2y/LLC7etC47frYhj+/QU5+9GDJ1lhuRlBGWkB6c3FbUXxJemB6an+qeVp1Q1FrSl+qVkhmRnBWW0V3VlhOUB2ondia3knw1+wn29cveNmFOVuGO2sG54WUhpgk+xqEOWkGx7mnBnnk2+rHuxjkeCoHZoWWuakE+ZtFm+p7J8SXAINsMePn2ZnlGemlQJRSXF9bnZlZloJkF2QWw3kZqSWZKWXZqWXlZU2ZmeWAxmpSYVtLRMYfv/+/efPn9t37nn4hrp6Bbv5hLh4BgIZQOQTGBkSmRgQGhscmeDhGwYUcfYASbn7hNq7+KZmFjL8/fsXaPOLl68mT50NQVOmzYGx50yZPnfazHlAEioClgIq6J84Y8my1Qz/8QKg0cBUBHQaVlkAmSGlUkLjd4IAAAAASUVORK5CYII=')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  })), \"\\n  \", mdx(\"img\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"VirtualAPK\",\n    \"title\": \"VirtualAPK\",\n    \"src\": \"/static/d9bbe7fecdd50b018b77ea33d7766d4a/7d769/virtual_apk_diagram.png\",\n    \"srcSet\": [\"/static/d9bbe7fecdd50b018b77ea33d7766d4a/5243c/virtual_apk_diagram.png 240w\", \"/static/d9bbe7fecdd50b018b77ea33d7766d4a/ab158/virtual_apk_diagram.png 480w\", \"/static/d9bbe7fecdd50b018b77ea33d7766d4a/7d769/virtual_apk_diagram.png 960w\", \"/static/d9bbe7fecdd50b018b77ea33d7766d4a/87339/virtual_apk_diagram.png 1440w\", \"/static/d9bbe7fecdd50b018b77ea33d7766d4a/56ba3/virtual_apk_diagram.png 1542w\"],\n    \"sizes\": \"(max-width: 960px) 100vw, 960px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  })), \"\\n  \"), \"\\n    \")), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"The \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://developer.android.com/guide/app-bundle/play-feature-delivery\"\n  }), \"GooglePlay dynamic feature delivery\"), \" system uses some of these reflection techniques to support legacy devices (pre Android 7.0) \\uD83D\\uDE48. For instance, \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"addAssetPath\"), \" is called via reflection to make resources not bundled in an APK available for use.\\n\", mdx(\"span\", _extends({\n    parentName: \"p\"\n  }, {\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"960px\"\n    }\n  }), \"\\n      \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"91.25000000000001%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAAB40lEQVQ4y41TCZKcMAzkNxvwbVk2GBuGIUw2xwfy/4+kgdnKsTNbUVFgwFK3Wu1m9GIgk/qchhzTEFOPi2MKeOQSKHRdJ55Ek5zw1gil2/ump1sfJA9eFtrBjdZSyj27+9/8RktRWddoe9LBO62NUurvPd0zOo2UylFwgRNZMspT4EAHBXkGasm3eJ8skhXZqxLMyKYEldnlMkG81PfMHOPAu4op9sM/pJodQGmlNAgjcHPWWGuB0rUQsTsleIyspIBmEKywzaQGUhEoQ8agsAA+7ejpnRBHMgqT99fty/p5q3UaS5mXdb19nS8LEYGQ2kM/FgyMAB6stN47Yh8YDRwCg/Wd9rPhAVlI0fUxTMt1rPMI8DpDHdW9dO3LUeEscVQ7FvuXM5k9iEnPCczrfKnT5bpuy+0Hl1cZZuvIeYKEzijn/LmwzkNaNNP0bOGtGON2e52WdVm3aZrz9ftw+6nyNwp96ocYXHSKMTwOySm4Hi3uye3hadSbp7le1jwWjDd6ycFGhmPYOWud05bA+tPRQ9vee2nO2YEJMpf1Nk61HyORISYeIkWMYk9Xb87fZ/6HSfYXNFYv15wLqKXMxmnvPU4lqIbA4pDr0aikgLfuJ+C3n8Rpa3kY+/mpMuaD3x/HLy+ayXZioHBBAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  })), \"\\n  \", mdx(\"img\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"Splitcompat source\",\n    \"title\": \"Splitcompat source\",\n    \"src\": \"/static/66a528e3618765871f563545a91cb424/7d769/split_compat_source.png\",\n    \"srcSet\": [\"/static/66a528e3618765871f563545a91cb424/5243c/split_compat_source.png 240w\", \"/static/66a528e3618765871f563545a91cb424/ab158/split_compat_source.png 480w\", \"/static/66a528e3618765871f563545a91cb424/7d769/split_compat_source.png 960w\", \"/static/66a528e3618765871f563545a91cb424/5d7c1/split_compat_source.png 1290w\"],\n    \"sizes\": \"(max-width: 960px) 100vw, 960px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  })), \"\\n    \"))), mdx(\"p\", null, \"This plugin approach adds cruft that is nonexistent on a regular device. An alternative is using the \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://developer.android.com/work/managed-profiles\"\n  }), \"Android work profile\"), \". Work profile creates a separate, self-contained profile on Android devices that isolates corporate data from personal apps and data. \", \"[3]\"), mdx(\"a\", {\n    \"href\": \"https://blog.google/products/android-enterprise/work-profile-new-standard-employee-privacy/\"\n  }, mdx(\"img\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"fit_image\",\n    \"src\": \"/a15aea53c7e448bdc96e55650ee95419/android_work_profiles.gif\",\n    \"alt\": \"Android work profile\"\n  }))), mdx(\"p\", null, \"Work profiles also provide always-on VPN configuration, control of runtime permissions, extra security, etc. Work profiles are a great fit, only deviating slightly from the operating mode used by the average user.\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"Android allows apps signed with the same key to run in the same process, if the apps so request, so that the system treats them as a single application. \", \"[3]\")), mdx(\"h3\", null, \"1.6. \\uD83D\\uDC94 Flakiness\"), mdx(\"p\", null, \"The system should eliminate most causes of flakiness that results from running tests on real peoples' devices \\u2014 I have run over \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"5,000 tests\"), \" so far without any issues \\uD83D\\uDE80. In an external network, it would be naive to assume perfection as there are so many variables introduced. As the project evolves, these issues would be identified and mitigated.\"), mdx(\"p\", null, \"A few researchers manually examined \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"423\"), \" projects featuring the Espresso automated GUI testing tool. They derived a set of \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"27\"), \" different causes of modifications and grouped them into \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"nine\"), \" macro-categories. Category percentages were then computed based on the frequency of modification causes. \", \"[2]\"), mdx(\"img\", {\n    \"className\": \"full_width_image\",\n    \"src\": \"/8779fc45863974d0b90fac96e035dd14/graphic_taxonomy_of_modification_causes.svg\"\n  }), mdx(\"h3\", null, \"1.7. \\uD83D\\uDEA7 Code Repository\"), mdx(\"p\", null, \"There are four primary directories in the \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/Elvis10ten/dart\"\n  }), \"Github repo\"), \":\"), mdx(\"p\", null, \"i. \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Apollo\"), \": Android project for the client (worker).\"), mdx(\"p\", null, \"ii. \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"WorkServer\"), \": Kotlin project for the gRPC work server.\"), mdx(\"p\", null, \"iii. \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"WorkSpecs\"), \": Protobuf definitions shared by both the server & Android client.\"), mdx(\"p\", null, \"iv. \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Dashboard\"), \": React project for the web dashboard.\"), mdx(\"p\", null, \"All projects are still a work in progress and lack adequate documentation.\"), mdx(\"h2\", null, \"2. \\uD83C\\uDFD7\\uFE0F System Overview\"), mdx(\"img\", {\n    \"className\": \"fit_image\",\n    \"src\": \"/1ffaeb44c8a342b87f8aea771c98c871/dart_work_flow.svg\"\n  }), mdx(\"p\", null, \"As shown above, multiple components must work in tandem to run tests on a device. The sequence diagram below shows the component interactions at a high-level.\"), mdx(\"div\", {\n    \"className\": \"mermaid\"\n  }, \"sequenceDiagram\\n    participant Worker as Worker (Device)\\n    participant WorkRunner\\n    participant TestServer\\n    participant TestClient\\n    participant Telemetry\\n    participant InstrumentationTests\\n    participant AppUnderTest\\n    participant UiAutomator\\n    \\n    activate Worker\\n    Worker->>WorkRunner: Run Work-X\\n    activate WorkRunner\\n\\n    WorkRunner->>WorkRunner: Download & unpack payload\\n    WorkRunner->>WorkRunner: Perform redundant cleanup\\n    \\n    WorkRunner->>UiAutomator: Connect UiAutomator\\n    activate UiAutomator\\n    UiAutomator-->>WorkRunner: Connected!\\n\\n    WorkRunner->>UiAutomator: Install AppUnderTest.apk\\n    UiAutomator-->>WorkRunner: Installed!\\n    WorkRunner->>UiAutomator: Install Test.apk\\n    UiAutomator-->>WorkRunner: Installed!\\n\\n    WorkRunner->>Worker: Kill other apps\\n    activate Worker\\n    Worker-->>WorkRunner: Killed!\\n    deactivate Worker\\n\\n    WorkRunner->>Worker: Dismiss system dialogs\\n    activate Worker\\n    Worker-->>WorkRunner: Dismissed!\\n    deactivate Worker\\n\\n    WorkRunner->>Worker: Activate DND\\n    activate Worker\\n    Worker-->>WorkRunner: Activated!\\n    deactivate Worker\\n\\n    WorkRunner->>TestServer: Start test server\\n    activate TestServer\\n    TestServer->>TestServer: Start timeout timer\\n    TestServer->>TestServer: Prepare test config\\n\\n    TestServer->>TestClient: Start Instrumentation(config)\\n    activate TestClient\\n    TestClient-->>TestServer: Started!\\n\\n    TestClient->>TestServer: Establish server connection\\n    TestServer-->>TestClient: Established!\\n    TestServer-xTestClient: Connect Activity boostrapper\\n\\n    TestClient->>UiAutomator: Acquire runtime permissions\\n    UiAutomator-->>TestClient: Acquired!\\n\\n    TestClient->>TestClient: Register componenets monitor\\n    TestClient->>Telemetry: Start telemetry\\n    activate Telemetry\\n    Telemetry-->>TestClient: Started!\\n\\n    par Telemetry\\n        loop every x milliseconds\\n            Telemetry->>Telemetry: Collect performance, UI, & device health data\\n            Telemetry-xTestClient: Store performance, UI, & device health data\\n            TestClient-xTestServer: Store performance, UI, & device health data\\n        end\\n    and Test Execution\\n        TestClient-xInstrumentationTests: Run all instrumentation tests\\n        activate InstrumentationTests\\n        activate AppUnderTest\\n\\n        loop for each test in config\\n            InstrumentationTests-xTestClient: On test-i run started\\n            TestClient-xTestServer: On test-i run started\\n            InstrumentationTests->>InstrumentationTests: Run test-i\\n            InstrumentationTests-xAppUnderTest: Interact with components\\n\\n            alt is test-i run successful\\n                InstrumentationTests-xTestClient: On test-i run successful!\\n                TestClient-xTestServer: On test-i run successful!\\n            else is test-i run failed\\n                InstrumentationTests-xTestClient: On test-i run failed!\\n                TestClient-xTestServer: On test-i run failed!\\n            end\\n            opt is test-i run ignored\\n                InstrumentationTests-xTestClient: On test-i run ignored!\\n                TestClient-xTestServer: On test-i run ignored!\\n            end\\n        end\\n\\n        deactivate AppUnderTest\\n        deactivate InstrumentationTests\\n\\n        TestClient-xTestServer: On instrumentation test completed!\\n        TestClient-xTestServer: Store artifacts\\n\\n        TestClient-xTelemetry: Stop telemetry\\n        deactivate Telemetry\\n    end\\n\\n    TestClient->>TestClient: Unregister components monitor\\n    TestClient-xTestServer: Disconnect from server\\n    TestClient->>TestClient: Cleanup & terminate\\n    deactivate TestClient\\n\\n    TestServer->>TestServer: Redundantly terminate client\\n    TestServer->>TestServer: Stop timeout timer\\n    TestServer->>TestServer: Assemble work report\\n    TestServer-xWorkRunner: On work completed(report)\\n\\n    WorkRunner-xTestServer: Stop test sever\\n    deactivate TestServer\\n    \\n    WorkRunner-->>Worker: Pack & upload Work-X report\\n    Worker->>WorkRunner: Finish\\n\\n    WorkRunner->>UiAutomator: Uninstall AppUnderTest.apk\\n    UiAutomator-->>WorkRunner: Success!\\n    WorkRunner->>UiAutomator: Uninstall Test.apk\\n    UiAutomator-->>WorkRunner: Success!\\n\\n    WorkRunner-xUiAutomator: Disconnect UiAutomator\\n    deactivate UiAutomator\\n\\n    WorkRunner->>Worker: Deactivate DND\\n    activate Worker\\n    Worker-->>WorkRunner: Deactivated!\\n    deactivate Worker\\n\\n    WorkRunner->>WorkRunner: Delete work data\\n    WorkRunner->>WorkRunner: Perform cleanup\\n    WorkRunner->>Worker: Runner finished!\\n    deactivate WorkRunner\\n    deactivate Worker\"), mdx(\"small\", null, \"Note: Lines with an \\\"x\\\" represent asynchronous messages (\", mdx(\"a\", {\n    href: \"https://github.com/mermaid-js/mermaid/issues/590\"\n  }, \"issue in Mermaid\"), \").\"), mdx(\"p\", null, \"The diagram shows the finite system states and their respective transitions.\"), mdx(\"div\", {\n    \"className\": \"mermaid\"\n  }, \"stateDiagram-v2\\n    [*] --> FindingWork: Start button clicked\\n    FindingWork --> [*]: Stop button clicked\\n\\n    FindingWork --> DownloadingPayload: Work found\\n    DownloadingPayload --> FindingWork: Payload download failed\\n\\n    DownloadingPayload --> UnpackingPayload: Payload downloaded\\n    UnpackingPayload --> FindingWork: Payload unpack failed\\n\\n    UnpackingPayload --> InstallingWork: Payload unpacked\\n    InstallingWork --> FindingWork: Install failed\\n\\n    InstallingWork --> PreparingRun: Payload installed\\n    PreparingRun --> FindingWork: Run preparation failed\\n\\n    PreparingRun --> RunningWork: Run preparation successful\\n    RunningWork --> FindingWork: Run failed\\n\\n    state RunningWork {\\n        [*] --> RunningTest\\n        RunningTest --> RunningTest: Retry tests\\n        RunningTest --> [*]\\n    }\\n\\n    RunningWork --> FinalizingRun: Run completed\\n\\n    FinalizingRun --> PackingResults: Run finalized\\n    PackingResults --> FindingWork: Result packing failed\\n\\n    PackingResults --> UploadingResults: Result packed\\n    UploadingResults --> FindingWork: Upload result failed\\n\\n    UploadingResults --> CleaningUpWork: Result uploaded\\n    CleaningUpWork --> FindingWork: Cleanup completed\"), mdx(\"p\", null, \"The next few sections cover individual system components. For the sake of brevity, I exclude codes that are irrelevant to the topic at hand. For each component, I only focus on some key ideas. You can always explore the \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/Elvis10ten/dart\"\n  }), \"Github repo\"), \" for the full source code.\"), mdx(\"h2\", null, \"3. \\uD83E\\uDD16 UiAutomator\"), mdx(\"p\", null, \"The framework's \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"UiAutomation\"), \" can't be used when tests aren't run traditionally. Fortunately, the functionalities of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"UiAutomation\"), \" can be replicated using the platform \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Accessibility APIs\"), \" and some other functionally equivalent alternatives. As evident from the documentation, \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"UiAutomation\"), \" can be viewed as an \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AccessiblityService\"), \" with extras.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-java:title=android.app.UiAutomation.java\"\n  }), \"/**\\n * Class for interacting with the device's UI by simulation user actions and\\n * introspection of the screen content. It relies on the platform accessibility\\n * APIs to introspect the screen and to perform some actions on the remote view\\n * tree. It also allows injecting of arbitrary raw input events simulating user\\n * interaction with keyboards and touch devices. One can think of a UiAutomation\\n * as a special type of {@link android.accessibilityservice.AccessibilityService}\\n * which does not provide hooks for the service life cycle and exposes other\\n * APIs that are useful for UI test automation.\\n * <p>\\n * The APIs exposed by this class are low-level to maximize flexibility when\\n * developing UI test automation tools and libraries. Generally, a UiAutomation\\n * client should be using a higher-level library or implement high-level functions.\\n * For example, performing a tap on the screen requires construction and injecting\\n * of a touch down and up events which have to be delivered to the system by a\\n * call to {@link #injectInputEvent(InputEvent, boolean)}.\\n * </p>\\n * <p>\\n * The APIs exposed by this class operate across applications enabling a client\\n * to write tests that cover use cases spanning over multiple applications. For\\n * example, going to the settings application to change a setting and then\\n * interacting with another application whose behavior depends on that setting.\\n * </p>\\n */\\npublic final class UiAutomation {\\n}\\n\")), mdx(\"p\", null, \"The alternative \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"UiAutomation\"), \" (internal) server can be implemented like this:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kotlin:title=UiAutomationServer.kt\"\n  }), \"class UiAutomationServer(\\n    private val screenRotator: ScreenRotator,\\n    private val screenViewer: ScreenViewer,\\n    private val appPermissioner: AppPermissioner\\n): AutomationServer.Stub() {\\n\\n    var lastAccessibilityEvent: AccessibilityEvent? = null\\n    var accessibilityEventListener: OnAccessibilityEventListener? = null\\n\\n    fun onAccessibilityEvent(event: AccessibilityEvent) {\\n        lastAccessibilityEvent = event\\n\\n        val uiEvent = addUiEvent(event)\\n        accessibilityEventListener?.onAccessibilityEvent(uiEvent)\\n    }\\n\\n    override fun setOnAccessibilityEventListener(listener: OnAccessibilityEventListener?) {\\n        accessibilityEventListener = listener\\n    }\\n\\n    override fun findFocus(focus: Int) =\\n        runWithOriginalIdentity { AutomationService.INSTANCE?.findFocus(focus) }\\n\\n    override fun performGlobalAction(action: Int) =\\n        runWithOriginalIdentity { AutomationService.INSTANCE?.performGlobalAction(action) ?: false }\\n\\n    override fun getLastEvent() = lastAccessibilityEvent\\n\\n    override fun setRotation(rotation: Int) =\\n        runWithOriginalIdentity { screenRotator.setRotation(rotation) }\\n\\n    override fun unfreezeCurrentRotation() =\\n        runWithOriginalIdentity { screenRotator.unfreezeCurrentRotation() }\\n\\n    override fun freezeCurrentRotation() =\\n        runWithOriginalIdentity { screenRotator.freezeCurrentRotation() }\\n\\n\\n    override fun restoreInitialRotation() =\\n        runWithOriginalIdentity { screenRotator.restoreInitialSettings() }\\n\\n    override fun getWindows(): List<AccessibilityWindowInfo> =\\n        runWithOriginalIdentity { AutomationService.INSTANCE?.windows ?: emptyList() }\\n\\n    override fun findAccessibilityNodeInfosByText(nodeInfo: UiNodeInfo, text: String): List<UiNodeInfo> {\\n        return try {\\n            nodeInfo.accessibilityNodeInfo.findAccessibilityNodeInfosByText(text).map {\\n                addUiNodeInfo(it)\\n            }\\n        } catch (e: Exception) {\\n            Timber.e(e)\\n            emptyList()\\n        }\\n    }\\n\\n    override fun findAccessibilityNodeInfosByViewId(nodeInfo: UiNodeInfo, viewId: String): List<UiNodeInfo> {\\n        return try {\\n            nodeInfo.accessibilityNodeInfo.findAccessibilityNodeInfosByViewId(viewId).map {\\n                addUiNodeInfo(it)\\n            }\\n        } catch (e: Exception) {\\n            Timber.e(e)\\n            emptyList()\\n        }\\n    }\\n\\n    override fun performNodeAction(nodeInfo: UiNodeInfo, action: Int): Boolean {\\n        return nodeInfo.accessibilityNodeInfo.performAction(action)\\n    }\\n\\n    override fun getUiEventSource(event: UiEvent): UiNodeInfo? {\\n        return event.accessibilityEvent.source?.let { addUiNodeInfo(it) }\\n    }\\n\\n    override fun getRootInActiveWindow() =\\n        runWithOriginalIdentity { AutomationService.INSTANCE?.rootInActiveWindow }\\n\\n    override fun getServiceInfo() =\\n        runWithOriginalIdentity { AutomationService.INSTANCE?.serviceInfo }\\n\\n    override fun setServiceInfo(serviceInfo: AccessibilityServiceInfo): Boolean {\\n        return runWithOriginalIdentity {\\n            AutomationService.INSTANCE?.let {\\n                // TODO: Security on ServiceInfo from clients. This maybe should be validated/restricted.\\n                it.serviceInfo = serviceInfo\\n                return@runWithOriginalIdentity true\\n            }\\n\\n            return@runWithOriginalIdentity false\\n        }\\n    }\\n\\n    override fun takeScreenshot(): Bitmap? {\\n        return try {\\n            screenViewer.capture()\\n        } catch (e: Exception) {\\n            Timber.e(e, \\\"Failed to take screenshot\\\")\\n            null\\n        }\\n    }\\n}\\n\\ninline fun <R> runWithOriginalIdentity(action: () -> R): R {\\n    Binder.clearCallingIdentity()\\n    val identity = Binder.clearCallingIdentity()\\n    try {\\n        return action()\\n    } finally {\\n        Binder.restoreCallingIdentity(identity)\\n    }\\n}\\n\")), mdx(\"p\", null, \"Not all functionality is directly available using the platform \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Accessibility APIs\"), \". For instance, \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"DevicePolicyManager\"), \" is used to grant runtime permissions & \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"MediaProjector\"), \" for device-wide screenshots.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kotlin:AppPermissioner.kt\"\n  }), \"class AppPermissioner(\\n    private val appContext: Context,\\n    private val devicePolicyManager: DevicePolicyManager\\n    private val adminComponent: ComponentName\\n) {\\n\\n    @TargetApi(Build.VERSION_CODES.M)\\n    fun grantRuntimePermissionAsUser(packageName: String, permission: String, userHandle: UserHandle) {\\n        devicePolicyManager.setPermissionGrantState(\\n            adminComponent,\\n            packageName,\\n            permission,\\n            PERMISSION_GRANT_STATE_GRANTED\\n        )\\n    }\\n\\n    @TargetApi(Build.VERSION_CODES.M)\\n    fun revokeRuntimePermissionAsUser(packageName: String, permission: String, userHandle: UserHandle) {\\n        devicePolicyManager.setPermissionGrantState(\\n            adminComponent,\\n            packageName,\\n            permission,\\n            PERMISSION_GRANT_STATE_DEFAULT\\n        )\\n    }\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kotlin:title=Screenshot.kt\"\n  }), \"private const val DISPLAY_NAME_SCREENSHOT = \\\"ScreenyScreenshotDisplay\\\"\\n// Max images is set to 2 to allow [ImageReader.acquireLatestImage] to do its thing\\nprivate const val MAX_IMAGES = 2\\nprivate const val SCREENSHOT_TIMEOUT_MILLIS = 10_000L\\nprivate const val LOG_TAG = \\\"Screenshot\\\"\\n\\ninternal class Screenshot(\\n    private val mediaProjection: MediaProjection,\\n    private val backgroundHandler: Handler\\n) {\\n\\n    fun capture(windowManager: WindowManager): Bitmap? {\\n        Log.i(LOG_TAG, \\\"Capturing Screenshot!\\\")\\n        val countDownLatch = CountDownLatch(1)\\n        val displayProps = windowManager.getDefaultDisplayProps()\\n        val imageReader = ImageReader.newInstance(displayProps.width, displayProps.height, PixelFormat.RGBA_8888, MAX_IMAGES)\\n        var bitmap: Bitmap? = null\\n\\n        val virtualDisplay = mediaProjection.createVirtualDisplay(\\n            DISPLAY_NAME_SCREENSHOT,\\n            displayProps,\\n            imageReader.surface,\\n            backgroundHandler\\n        ) {\\n            countDownLatch.countDown()\\n        }\\n\\n        imageReader.setOnImageAvailableListener({\\n            imageReader.setOnImageAvailableListener(null, null)\\n            val image = imageReader.acquireLatestImage()\\n\\n            image.close()\\n            \\n            try {\\n                bitmap = image.getBitmap(displayProps)\\n                Log.i(LOG_TAG, \\\"Screenshot captured!!\\\")\\n            } catch (e: Exception) {\\n                Log.e(LOG_TAG, \\\"Failed to get bitmap from image\\\", e)\\n            } finally {\\n                image.closeCatching { Log.e(LOG_TAG, \\\"Error closing Image\\\", it) }\\n                imageReader.closeCatching { Log.e(LOG_TAG, \\\"Error closing ImageReader\\\", it) }\\n                virtualDisplay.surface = null\\n                countDownLatch.countDown()\\n            }\\n        }, backgroundHandler)\\n\\n        try {\\n            countDownLatch.await(SCREENSHOT_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS)\\n        } finally {\\n            virtualDisplay.release()\\n        }\\n\\n        return bitmap\\n    }\\n}\\n\\n@WorkerThread\\nprivate fun Image.getBitmap(displayProps: DisplayProperties): Bitmap {\\n    val buffer: ByteBuffer = planes.first().buffer\\n    val pixelStride = planes.first().pixelStride\\n    val rowStride = planes.first().rowStride\\n    val rowPadding = rowStride - pixelStride * displayProps.width\\n\\n    val bitmap = Bitmap.createBitmap(\\n        displayProps.width + (rowPadding.toFloat() / pixelStride.toFloat()).toInt(),\\n        displayProps.height,\\n        Bitmap.Config.ARGB_8888\\n    )\\n\\n    bitmap.copyPixelsFromBuffer(buffer)\\n    return bitmap\\n}\\n\")), mdx(\"p\", null, \"A custom class with the exact set of functions is used as a drop-in replacement for \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"UiAutomation\"), \". Client test code either has to use this custom class directly or use a Gradle plugin that changes the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"import\"), \" using bytecode manipulation.\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"The AccessibilityService runs in a dedicated process to isolate it from the work runner app. Also, we use a proxy service to communicate with the AccessibilityService because onBind is final.\")), mdx(\"h2\", null, \"4. \\uD83D\\uDD79\\uFE0F TestServer\"), mdx(\"p\", null, \"Once the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"AppUnderTest.apk\"), \" and \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Test.apk\"), \" has been installed, the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TestServer\"), \" calls the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Context.startInstrumentation\"), \" function to run the test cases.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-java:title=android.content.Context\"\n  }), \"    /**\\n     * Start executing an {@link android.app.Instrumentation} class.  The given\\n     * Instrumentation component will be run by killing its target application\\n     * (if currently running), starting the target process, instantiating the\\n     * instrumentation component, and then letting it drive the application.\\n     *\\n     * <p>This function is not synchronous -- it returns as soon as the\\n     * instrumentation has started and while it is running.\\n     *\\n     * <p>Instrumentation is normally only allowed to run against a package\\n     * that is either unsigned or signed with a signature that the\\n     * the instrumentation package is also signed with (ensuring the target\\n     * trusts the instrumentation).\\n     *\\n     * @param className Name of the Instrumentation component to be run.\\n     * @param profileFile Optional path to write profiling data as the\\n     * instrumentation runs, or null for no profiling.\\n     * @param arguments Additional optional arguments to pass to the\\n     * instrumentation, or null.\\n     *\\n     * @return {@code true} if the instrumentation was successfully started,\\n     * else {@code false} if it could not be found.\\n     */\\n    public abstract boolean startInstrumentation(@NonNull ComponentName className,\\n            @Nullable String profileFile, @Nullable Bundle arguments);\\n\")), mdx(\"p\", null, \"For the arguments parameter, a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Bundle\"), \" is populated with configuration details from the server.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kotlin:title=TestConfigs.kt\"\n  }), \"class TestConfigs(private val arguments: Bundle) {\\n\\n    fun isObscureWindowEnabled() = arguments.getBoolean(ARG_OBSCURE_WINDOW_ENABLED)\\n\\n    fun shouldRetrieveTestFiles() = arguments.getBoolean(ARG_RETRIEVE_TEST_FILES)\\n\\n    fun shouldRetrieveAppFiles() = arguments.getBoolean(ARG_RETRIEVE_APP_FILES)\\n\\n    fun getTestsCount() = arguments.getInt(ARG_TESTS_COUNT)\\n\\n    fun getProfilerSampleFrequency() = arguments.getInt(ARG_PROFILER_SAMPLE_FREQUENCY)\\n\\n    fun isClearDataEnabled() = arguments.getBoolean(ARG_CLEAR_DATA)\\n\\n    fun isAutoScreenShotEnabled() = arguments.getBoolean(ARG_AUTO_SCREEN_SHOT_ENABLED)\\n\\n    fun getAutoScreenShotFps() = arguments.getInt(ARG_AUTO_SCREEN_SHOT_FPS)\\n\\n    fun getScreenShotQuality() = arguments.getInt(ARG_AUTO_SCREEN_QUALITY)\\n}\\n\")), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TestObserver.aidl\"), \" is defined for \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TestClient\"), \" \", \"<\", \">\", \" \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TestServer\"), \" communication.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kt:title=TestCallback.aidl\"\n  }), \"interface TestCallback {\\n\\n    void onTestRunStarted(in TestDescription description);\\n\\n    void onTestRunFinished(in TestResult result);\\n\\n    void onTestStarted(\\n        in TestDescription description,\\n        String logFileName,\\n        String profilerFileName,\\n        String autoScreenShotNamePrefix\\n    );\\n\\n    void onTestFinished(in TestDescription description);\\n\\n    void onTestFailure(in TestFailure failure);\\n\\n    void onTestAssumptionFailure(in TestFailure failure);\\n\\n    void onTestIgnored(in TestDescription description);\\n\\n    void onProcessCrashed(in TestDescription failure, String stackTrace);\\n\\n    void onClientConnected(Finisher finisher);\\n\\n    void onInterrupted(int reasonId);\\n\\n    void sendString(String message);\\n}\\n\")), mdx(\"h3\", null, \"4.1. \\uD83D\\uDCBE Remote Storage\"), mdx(\"p\", null, \"Logs and other artifacts need to be \\\"streamed\\\" to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TestServer\"), \". This data needs to be stored in the server's private directory but the Android security model doesn't allow foreign apps to write directly into an app's private directories. This limitation can be circumvented using a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ContentProvider\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"FileDescriptors\"), \".\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kt:title=RemoteStorageConstants.kt\"\n  }), \"object RemoteStorageConstants {\\n\\n    const val PREFIX_CONTENT = \\\"content://\\\"\\n    const val AUTHORITY = \\\"com.fluentbuild.apollo.runtime.remotestorage\\\"\\n    const val BASE_URI = \\\"${PREFIX_CONTENT}${AUTHORITY}/\\\"\\n\\n    const val MODE_READ = \\\"r\\\"\\n    const val MODE_WRITE = \\\"w\\\"\\n    const val MODE_APPEND = \\\"wa\\\"\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kt:title=RemoteStorageProvider.kt\"\n  }), \"private const val REMOTE_STORAGE_DIR = \\\"stash\\\"\\n\\nclass RemoteStorageProvider: ContentProvider() {\\n\\n    override fun openFile(uri: Uri, mode: String): ParcelFileDescriptor? {\\n        val child = uri.toString().substringAfter(RemoteStorageConstants.BASE_URI)\\n        if(child.isBlank()) return null\\n\\n        return try {\\n            File(getDir(context!!), child).run {\\n                Timber.i(\\\"Opening file: %s with mode: %s\\\", absolutePath, mode)\\n                parentFile?.mkdirs()\\n                openParcelFileDescriptor(mode)\\n            }\\n        } catch (e: Exception) {\\n            null\\n        }\\n    }\\n\\n    companion object {\\n\\n        fun getDir(context: Context) = File(context.filesDir, REMOTE_STORAGE_DIR).apply { mkdirs() }\\n    }\\n}\\n\")), mdx(\"h2\", null, \"5. \\uD83E\\uDDEB TestClient\"), mdx(\"p\", null, \"The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TestClient\"), \" is included in the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Test.apk\"), \" and controls test execution. It is part of the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"\\\"com.fluentbuild.apollo:client:version\\\"\"), \" artifact.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kt:title=TestClient.kt\"\n  }), \"private const val LOG_TAG = \\\"TestClient\\\"\\nprivate const val RUNNER_PACKAGE = \\\"com.fluentbuild.apollo\\\"\\nprivate const val RUNNER_SERVICE = \\\"com.fluentbuild.apollo.RunnerService\\\"\\nprivate const val SERVICE_CONNECTION_TIMEOUT_MILLIS = 10_000L\\n\\n/**\\n * For the current instrumentation to communicate information back to the RuntimeService.\\n *\\n */\\nclass TestClient(\\n    private val instrumentation: Instrumentation,\\n    private val clientFinalizer: ClientFinalizer,\\n    private val logWrapper: LogWrapper\\n): WorkInterruptCallback {\\n\\n    private val connectionLatch = CountDownLatch(1)\\n\\n    @Volatile\\n    private lateinit var testCallback: TestCallback\\n\\n    private val serviceConnection = object : ServiceConnection {\\n\\n        override fun onServiceConnected(className: ComponentName, service: IBinder) {\\n            logWrapper.i(LOG_TAG, \\\"TestClient connected to runner service\\\")\\n            testCallback = TestCallback.Stub.asInterface(service)\\n            connectionLatch.countDown()\\n        }\\n\\n        override fun onServiceDisconnected(className: ComponentName) {\\n            logWrapper.e(LOG_TAG, \\\"TestClient is disconnected from runner service\\\")\\n            instrumentation.finishInstrumentation(Activity.RESULT_CANCELED)\\n        }\\n    }\\n\\n    // Called on the test thread\\n    fun connect() {\\n        logWrapper.i(LOG_TAG, \\\"Connecting to runner service\\\")\\n\\n        val intent = Intent()\\n        intent.setClassName(RUNNER_PACKAGE, RUNNER_SERVICE)\\n\\n        instrumentation.context.requireServiceBind(intent, serviceConnection)\\n\\n        if(!connectionLatch.await(SERVICE_CONNECTION_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS)) {\\n            unbindService()\\n            throw TimeoutException(\\\"Couldn't connect to runner service\\\")\\n        }\\n\\n        onClientConnected()\\n    }\\n\\n    private fun onClientConnected() {\\n        try {\\n            testCallback.onClientConnected(object : Finisher.Stub() {\\n\\n                override fun finish(resultCode: Int) {\\n                    logWrapper.i(LOG_TAG, \\\"Instrumentation finish requested\\\")\\n                    clientFinalizer.finalize()\\n                    instrumentation.finishInstrumentation(resultCode)\\n                }\\n            })\\n        } catch (e: RemoteException) {\\n            handleRemoteFailure(\\\"Unable to notify runner service of connection!\\\", e)\\n        }\\n    }\\n\\n    @MainThread\\n    fun disconnect() {\\n        unbindService()\\n    }\\n\\n    // Just simple test callbacks below\\n}\\n\")), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TestClient\"), \" works in tandem with an instance of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Instrumentation\"), \". A custom instance is required to be able to intercept \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Instrumentation\"), \" callbacks. In the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"\\\"com.fluentbuild.apollo:client:version\\\"\"), \" artifact, an implementation that subclasses \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AndroidJUnitRunner\"), \" is provided. A reflection hack is used to register a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"org.junit.runner.notification.RunListener\"), \" in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AndroidJUnitRunner\"), \".\"), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TestClient\"), \" works in tandem with an instance of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Instrumentation\"), \". A custom instance is required to be able to intercept \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Instrumentation\"), \" callbacks. In the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"\\\"com.fluentbuild.apollo:client:version\\\"\"), \" artifact, an implementation that subclasses \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AndroidJUnitRunner\"), \" is provided. In this implementation, I used a reflection hack to hook into the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"InstrumentationResultPrinter\"), \". Passing in the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TestObserver\"), \", which captures test states and eventually calls into the real printer.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kt\"\n  }), \"private fun init(testConfigs: TestConfigs) {\\n    val printerField = getPrinterField()\\n    val printer = printerField.get(runner) as InstrumentationResultPrinter\\n    initializer.init(testConfigs, printer)\\n    printerField.set(runner, initializer.getTestObserver())\\n}\\n\\nprivate fun getPrinterField(): Field {\\n    return AndroidJUnitRunner::class.java.getDeclaredField(\\\"instrumentationResultPrinter\\\")\\n        .apply { isAccessible = true }\\n}\\n\")), mdx(\"p\", null, \"For publishers that don't use \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AndroidJunitRunner\"), \", they can still use the client artifact by calling into the relevant functions.\"), mdx(\"h4\", null, \"5.2. \\uD83D\\uDD10 Runtime Permissions\"), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"UiAutomation\"), \" can be used to request runtime permission. An extra layer similar to the one in the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"androidx.test.runner.permission\"), \" package can be created to simplify this flow.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kotlin:title=PermissionGranter.kt\"\n  }), \"/**\\n * Requests a runtime permission on devices running Android M (API 23) and above.\\n *\\n * This class is usually used to grant runtime permissions to avoid the permission dialog from\\n * showing up and blocking the App's Ui. This is especially helpful for Ui-Testing to avoid loosing\\n * control over your application under test.\\n *\\n * The requested permissions will be granted for all test methods in the test class. Use [addPermissions] to add a permission to the permission list. To request all\\n * permissions use the [requestPermissions] method.\\n *\\n */\\ninterface PermissionGranter {\\n\\n    /**\\n     * Adds a permission to the list of permissions which will be requested when [.requestPermissions] is called.\\n     *\\n     * Precondition: This method does nothing when called on an API level lower than [Build.VERSION_CODES.M].\\n     *\\n     * @param permissions a list of Android runtime permissions.\\n     */\\n    fun addPermissions(vararg permissions: String)\\n\\n    /**\\n     * Request all permissions previously added using [.addPermissions]\\n     *\\n     * Precondition: This method does nothing when called on an API level lower than [ ][Build.VERSION_CODES.M].\\n     */\\n    fun requestPermissions()\\n}\\n\")), mdx(\"h4\", null, \"5.3. \\uD83D\\uDD2C Components Monitor\"), mdx(\"p\", null, \"The components of the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"AppUnderTest\"), \" are closely monitored to power some telemetry functionalities. For each type of component, we create an implementation of the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Monitor\"), \" interface.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kt:title=Monitor.kt\"\n  }), \"abstract class Monitor<CallbackT> {\\n\\n    protected val callbacks = mutableListOf<WeakReference<CallbackT>>()\\n\\n    internal fun registerCallback(callback: CallbackT) {\\n        if(callbacks.none { it.get() == callback }) {\\n            callbacks += WeakReference(callback)\\n        }\\n    }\\n\\n    internal fun unregisterCallback(callback: CallbackT) {\\n        callbacks.removeAll { it.get() == callback }\\n    }\\n}\\n\")), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AppMonitor\"), \" monitors the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Application\"), \" lifecycle.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kt:title=AppMonitor.kt\"\n  }), \"class AppMonitor: Monitor<AppMonitor.Callback>() {\\n\\n    private var appRef: WeakReference<Application>? = null\\n\\n    private fun signalLifecycleChange(application: Application, stage: ApplicationStats.Stage) {\\n        callbacks.forEach { it.get()?.onStageChanged(application, stage) }\\n    }\\n\\n    fun onCallApplicationOnCreate(app: Application, action: () -> Unit) {\\n        appRef = WeakReference(app)\\n        signalLifecycleChange(app, ApplicationStats.Stage.PRE_ON_CREATE)\\n        action()\\n        signalLifecycleChange(app, ApplicationStats.Stage.CREATED)\\n    }\\n\\n    fun getActiveApp(): Application? = appRef?.get()\\n\\n    interface Callback {\\n        fun onStageChanged(app: Application, stage: ApplicationStats.Stage)\\n    }\\n}\\n\")), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ActivityMonitor\"), \" monitors the lifecycle of all activities in the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"AppUnderTest\"), \". The action function allows the monitor control when the caller (the Instrumentation) can pass the event downstream.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kt:title=ActivityMonitor.kt\"\n  }), \"class ActivityMonitor: Monitor<ActivityMonitor.Callback>() {\\n\\n    private val activeActivities = WeakHashMap<Activity, ActivityStats.Stage>()\\n\\n    private fun signalLifecycleChange(activity: Activity, stage: ActivityStats.Stage) {\\n        activeActivities[activity] = stage\\n        callbacks.forEach {\\n            it.get()?.onStageChanged(activity, stage)\\n        }\\n    }\\n\\n    fun onCallActivityOnDestroy(activity: Activity, action: () -> Unit) {\\n        signalLifecycleChange(activity, ActivityStats.Stage.DESTROYED)\\n        action()\\n        activeActivities.remove(activity)\\n    }\\n\\n    fun onCallActivityOnRestart(activity: Activity, action: () -> Unit) {\\n        action()\\n        signalLifecycleChange(activity, ActivityStats.Stage.RESTARTED)\\n    }\\n\\n    fun onCallActivityOnCreate(activity: Activity, bundle: Bundle?, action: () -> Unit) {\\n        signalLifecycleChange(activity, ActivityStats.Stage.PRE_ON_CREATE)\\n        action()\\n        signalLifecycleChange(activity, ActivityStats.Stage.CREATED)\\n    }\\n\\n    fun onCallActivityOnCreate(\\n        activity: Activity,\\n        bundle: Bundle?,\\n        persistentState: PersistableBundle,\\n        action: () -> Unit\\n    ) {\\n        signalLifecycleChange(activity, ActivityStats.Stage.PRE_ON_CREATE)\\n        action()\\n        signalLifecycleChange(activity, ActivityStats.Stage.CREATED)\\n    }\\n\\n    fun onCallActivityOnStart(activity: Activity, action: () -> Unit) {\\n        action()\\n        signalLifecycleChange(activity, ActivityStats.Stage.STARTED)\\n    }\\n\\n    fun onCallActivityOnStop(activity: Activity, action: () -> Unit) {\\n        action()\\n        signalLifecycleChange(activity, ActivityStats.Stage.STOPPED)\\n    }\\n\\n    fun onCallActivityOnResume(activity: Activity, action: () -> Unit) {\\n        action()\\n        signalLifecycleChange(activity, ActivityStats.Stage.RESUMED)\\n    }\\n\\n    fun onCallActivityOnPause(activity: Activity, action: () -> Unit) {\\n        action()\\n        signalLifecycleChange(activity, ActivityStats.Stage.PAUSED)\\n    }\\n    \\n    fun getActiveActivities(): Set<Activity>  {\\n        return activeActivities.keys\\n    }\\n\\n    interface Callback {\\n        fun onStageChanged(activity: Activity, stage: ActivityStats.Stage)\\n    }\\n}\\n\")), mdx(\"h3\", null, \"5.4. \\uD83D\\uDD02 JUnit\"), mdx(\"p\", null, \"Only \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Parcelable\"), \" classes can be used in AIDL IPC calls. Because of this constraint, the following model classes were created to pass notifications from JUnit to the server.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kotlin:title=Models.kt\"\n  }), \"data class TestDescription(\\n    val className: String,\\n    val methodName: String?,\\n    val displayName: String\\n): Parcelable\\n\\ndata class TestFailure(\\n    val description: TestDescription,\\n    val trace: String\\n): Parcelable\\n\\ndata class TestResult(\\n    val runtimeMillis: Long,\\n    val ignoreCount: Int,\\n    val failures: List<TestFailure>\\n): Parcelable\\n\")), mdx(\"p\", null, \"The jUnit models will need to be mapped to the model classes defined above.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kotlin:title=ModelsMapper.kt\"\n  }), \"private const val MAX_TRACE_SIZE = 64 * 1024\\n\\ninternal fun Description.createTestModel(): TestDescription {\\n    return TestDescription(className, methodName, displayName)\\n}\\n\\ninternal fun Failure.createTestModel(): TestFailure {\\n    var stackTrace = trace\\n\\n    if (stackTrace.length > MAX_TRACE_SIZE) {\\n        // Since we report failures back to the runtime via a binder IPC, we need to make sure that\\n        // we don't exceed the Binder transaction limit - which is 1MB per process.\\n        Log.w(LOG_TAG, \\\"Stack trace too long, trimmed to first $MAX_TRACE_SIZE characters.\\\")\\n        stackTrace = trace.substring(0, MAX_TRACE_SIZE) + \\\"\\\\n\\\"\\n    }\\n\\n    return TestFailure(description.createTestModel(), stackTrace)\\n}\\n\\ninternal fun Result.createTestModel(): TestResult {\\n    return TestResult(runTime, ignoreCount, failures.map { it.createTestModel() })\\n}\\n\")), mdx(\"p\", null, \"The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TestObserver\"), \" is an instance of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"org.junit.runner.notification.RunListener\"), \", and is notified of events that occur during a test run. These events are passed to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TestClient\"), \" which then passes it to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TestServer\"), \".\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kt:title=TestObserver.kt\"\n  }), \"internal class TestObserver(\\n    private val testClient: TestClient,\\n    private val wrappedPrinter: InstrumentationResultPrinter,\\n    private val clientFinalizer: ClientFinalizer,\\n    private val collatorsManager: CollatorsManager\\n): InstrumentationResultPrinter() {\\n\\n    private var startedCount = 0\\n    private var lastStartedTest: Description? = null\\n\\n    override fun testRunStarted(description: Description) {\\n        testClient.testRunStarted(description)\\n        wrappedPrinter.testRunStarted(description)\\n    }\\n\\n    override fun testStarted(description: Description) {\\n        lastStartedTest = description\\n        startedCount++\\n        testClient.testStarted(description, collatorsManager.getInfo())\\n        wrappedPrinter.testStarted(description)\\n    }\\n\\n    override fun testAssumptionFailure(failure: Failure) {\\n        testClient.testAssumptionFailure(failure)\\n        restartMeasurement()\\n        wrappedPrinter.testAssumptionFailure(failure)\\n    }\\n\\n    override fun testRunFinished(result: Result) {\\n        testClient.testRunFinished(result)\\n        wrappedPrinter.testRunFinished(result)\\n    }\\n\\n    override fun sendString(msg: String) {\\n        testClient.sendString(msg)\\n        wrappedPrinter.sendString(msg)\\n    }\\n\\n    override fun instrumentationRunFinished(\\n        summaryWriter: PrintStream,\\n        resultBundle: Bundle,\\n        junitResults: Result\\n    ) {\\n        clientFinalizer.finalize()\\n        wrappedPrinter.instrumentationRunFinished(summaryWriter, resultBundle, junitResults)\\n    }\\n\\n    override fun testFailure(failure: Failure) {\\n        testClient.testFailure(failure)\\n        restartMeasurement()\\n        wrappedPrinter.testFailure(failure)\\n    }\\n\\n    override fun testFinished(description: Description) {\\n        testClient.testFinished(description)\\n        restartMeasurement()\\n        wrappedPrinter.testFinished(description)\\n    }\\n\\n    override fun testIgnored(description: Description) {\\n        testClient.testIgnored(description)\\n        restartMeasurement()\\n        wrappedPrinter.testIgnored(description)\\n    }\\n\\n    override fun reportProcessCrash(throwable: Throwable) {\\n        testClient.processCrashed(Failure(lastStartedTest, throwable))\\n        restartMeasurement()\\n        wrappedPrinter.reportProcessCrash(throwable)\\n    }\\n\\n    private fun restartMeasurement() {\\n        collatorsManager.restart()\\n    }\\n}\\n\")), mdx(\"h3\", null, \"5.5. \\uD83D\\uDC40 Obscuring Screen\"), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"OverlayView\"), \" is a simple custom fullscreen opaque view that is used to obscure Activities when requested. The overlay is attached to the window immediately after an Activity is created. I haven't noticed any interferences yet between the overlay and test UI interactions.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kotlin:title=WindowOverlay.kt\"\n  }), \"internal class WindowOverlay(activity: Activity) {\\n\\n    private val overlayView = OverlayView(activity)\\n\\n    init {\\n        activity.window.addContentView(overlayView.rootView, getWindowParams())\\n    }\\n\\n    fun updateLabel(labelText: String) {\\n        overlayView.updateLabel(labelText)\\n    }\\n\\n    fun getRoot() = overlayView.rootView\\n\\n    private fun getWindowParams(): WindowManager.LayoutParams {\\n        val type = if(AndroidVersion.isAtLeastOreo()) {\\n            WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY\\n        } else {\\n            @Suppress(\\\"DEPRECATION\\\")\\n            WindowManager.LayoutParams.TYPE_PHONE\\n        }\\n\\n        val formats = WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE or\\n                WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE or\\n                WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON or\\n                WindowManager.LayoutParams.FLAG_FULLSCREEN\\n\\n        return WindowManager.LayoutParams(\\n            WindowManager.LayoutParams.MATCH_PARENT,\\n            WindowManager.LayoutParams.MATCH_PARENT,\\n            type,\\n            formats,\\n            PixelFormat.TRANSPARENT\\n        )\\n    }\\n}\\n\")), mdx(\"h3\", null, \"5.5. \\uD83E\\uDD0F User Interrupts\"), mdx(\"p\", null, \"Any external interactions should immediately stop test execution to prevent interference. The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"NavigationInteractionObserver\"), \" detects when a user presses a button.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kotlin:title=NavigationInteractionObserver.kt\"\n  }), \"private const val SYSTEM_DIALOG_REASON_KEY = \\\"reason\\\"\\nprivate const val SYSTEM_DIALOG_REASON_GLOBAL_ACTIONS = \\\"globalactions\\\"\\nprivate const val SYSTEM_DIALOG_REASON_RECENT_APPS = \\\"recentapps\\\"\\nprivate const val SYSTEM_DIALOG_REASON_HOME_KEY = \\\"homekey\\\"\\n\\ninternal class NavigationInteractionObserver(private val callback: Callback): BroadcastReceiver() {\\n\\n    override fun onReceive(context: Context, intent: Intent) {\\n        val reason = intent.getStringExtra(SYSTEM_DIALOG_REASON_KEY)\\n\\n        if (reason == SYSTEM_DIALOG_REASON_HOME_KEY) {\\n            callback.onHomePressed()\\n        } else if (reason == SYSTEM_DIALOG_REASON_RECENT_APPS) {\\n            callback.onRecentAppsPressed()\\n        }\\n    }\\n\\n    fun start(context: Context) {\\n        context.registerReceiver(this, IntentFilter(Intent.ACTION_CLOSE_SYSTEM_DIALOGS))\\n    }\\n\\n    fun stop(context: Context) {\\n        context.unregisterReceiver(this)\\n    }\\n\\n    interface Callback {\\n\\n        fun onHomePressed()\\n\\n        fun onRecentAppsPressed()\\n    }\\n}\\n\")), mdx(\"p\", null, \"The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"WindowInteractionObserver\"), \" detects when a user taps on the screen.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kotlin:title=WindowInteractionObserver.kt\"\n  }), \"internal class WindowInteractionObserver(private val callback: Callback): ActivityMonitor.Callback {\\n\\n    override fun onStageChanged(activity: Activity, stage: ActivityStats.Stage) {\\n        if(stage == ActivityStats.Stage.CREATED) {\\n            activity.window.callback = object: WindowCallbackWrapper(activity.window.callback) {\\n\\n                override fun dispatchTouchEvent(event: MotionEvent): Boolean {\\n                    evaluateUserMotion(event)\\n                    return super.dispatchTouchEvent(event)\\n                }\\n\\n                override fun dispatchKeyEvent(event: KeyEvent): Boolean {\\n                    evaluateUserKeyInput(event)\\n                    return super.dispatchKeyEvent(event)\\n                }\\n            }\\n        }\\n    }\\n\\n    interface Callback {\\n\\n        fun onWindowTouchedByUser()\\n\\n        fun onKeyPressedByUser()\\n    }\\n}\\n\")), mdx(\"h3\", null, \"5.7. \\uD83D\\uDCBE Remote Storage\"), mdx(\"p\", null, \"The client can utilize the server's ContentProvider to save files in the server's private directory.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kt:title=FileDescriptorProvider.kt\"\n  }), \"class FileDescriptorProvider(private val context: Context) {\\n\\n    @Throws(Exception::class)\\n    internal fun getReadableDescriptor(fileName: String) = getDescriptor(fileName, MODE_READ)\\n\\n    @Throws(Exception::class)\\n    internal fun getWritableDescriptor(fileName: String) = getDescriptor(fileName, MODE_WRITE)\\n\\n    @Throws(Exception::class)\\n    internal fun getAppendableDescriptor(fileName: String) = getDescriptor(fileName, MODE_APPEND)\\n\\n    @Throws(Exception::class)\\n    private fun getDescriptor(fileName: String, mode: String): ParcelFileDescriptor =\\n        context.contentResolver.openFileDescriptor(getFileUri(fileName), mode)!!.apply { checkError() }\\n\\n    private fun getFileUri(filePath: String) = Uri.parse(\\\"${BASE_URI}${filePath}\\\")\\n}\\n\")), mdx(\"h3\", null, \"5.8. \\uD83E\\uDDF9 Finalizing\"), mdx(\"p\", null, \"After running all tests or when the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"AppUnderTest\"), \" crashes, all miscellaneous artifacts are moved to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TestServer\"), \".\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kt:title=ArtifactsCopier.kt\"\n  }), \"class ArtifactsCopier(\\n    private val targetContext: Context,\\n    private val instrumentationContext: Context,\\n    private val testConfigs: TestConfigs,\\n) {\\n\\n    fun copy() {\\n        if (testConfigs.shouldRetrieveTestFiles()) {\\n            copyDir(destinationDir = \\\"test_files\\\", sourceDir = instrumentationContext.filesDir)\\n        }\\n\\n        if (testConfigs.shouldRetrieveAppFiles()) {\\n            copyDir(destinationDir = \\\"app_files\\\", sourceDir = targetContext.filesDir)\\n        }\\n    }\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kotlin:title=ClearDataTask.kt\"\n  }), \"internal class ClearDataTask(private val targetContext: Context): Task {\\n\\n    override fun run() {\\n        targetContext.externalMediaDirs.forEach { it?.deleteRecursively() }\\n        targetContext.noBackupFilesDir.deleteRecursively()\\n\\n        targetContext.cacheDir.deleteRecursively()\\n        targetContext.codeCacheDir.deleteRecursively()\\n        targetContext.externalCacheDir?.deleteRecursively()\\n\\n        targetContext.filesDir.deleteRecursively()\\n        if(AndroidVersion.isAtLeastNougat()) {\\n            targetContext.dataDir.deleteRecursively()\\n        } else {\\n            targetContext.filesDir.parentFile?.deleteRecursively()\\n        }\\n    }\\n}\\n\")), mdx(\"h3\", null, \"5.9. \\u274C Cancelling\"), mdx(\"p\", null, \"When an error occurs transmitting test state, or when the server connection is broken, the client automatically cancels all executions. The server can also cancel the client using the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Finisher\"), \" interface.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-java:title=Finisher.aidl\"\n  }), \"interface Finisher {\\n    void finish(int resultCode);\\n}\\n\")), mdx(\"p\", null, \"When the connection to the client is severed, the server uses the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"CancelSignalObserver\"), \" in a last-ditch effort to terminate the client. The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"CancelSignalObserver\"), \" is a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"BroadcastReceiver\"), \" that is tied to the lifecycle of the test process.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kt:title=CancelSignalObserver.kt\"\n  }), \"class CancelSignalObserver(private val instrumentation: Instrumentation): BroadcastReceiver() {\\n\\n    override fun onReceive(context: Context, intent: Intent) {\\n        if(intent.action == ACTION_CANCEL_SIGNAL) {\\n            instrumentation.finishInstrumentation(Activity.RESULT_CANCELED)\\n        }\\n    }\\n\\n    fun start() {\\n        instrumentation.targetContext.registerReceiver(\\n            this,\\n            IntentFilter(ACTION_CANCEL_SIGNAL)\\n        )\\n    }\\n\\n    fun stop() {\\n        instrumentation.targetContext.unregisterReceiver(this)\\n    }\\n}\\n\")), mdx(\"h3\", null, \"6. \\u23F1\\uFE0F Telemetry\"), mdx(\"p\", null, \"While tests are running, performance & device health data is periodically collated and stored. Protocol buffers are used for data serialization.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-protobuf:title=MemoryStats.proto\"\n  }), \"message MemoryStats {\\n\\n    /** The proportional set size for dalvik heap.  (Doesn't include other Dalvik overhead.) */\\n    int32 appDalvikPss = 1;\\n\\n    /** The private dirty pages used by dalvik heap. */\\n    int32 appDalvikPrivateDirty = 2;\\n\\n    /** The shared dirty pages used by dalvik heap. */\\n    int32 appDalvikSharedDirty = 3;\\n\\n    /** The proportional set size for the native heap. */\\n    int32 appNativePss = 4;\\n\\n    /** The private dirty pages used by the native heap. */\\n    int32 appNativePrivateDirty = 5;\\n\\n    /** The shared dirty pages used by the native heap. */\\n    int32 appNativeSharedDirty = 6;\\n\\n    /** The proportional set size for everything else. */\\n    int32 appOtherPss = 7;\\n\\n    /** The private dirty pages used by everything else. */\\n    int32 appOtherPrivateDirty = 8;\\n\\n    /** The shared dirty pages used by everything else. */\\n    int32 appOtherSharedDirty = 9;\\n\\n    /**\\n    * The total memory accessible by the kernel.  This is basically the\\n    * RAM size of the device, not including below-kernel fixed allocations\\n    * like DMA buffers, RAM for the baseband CPU, etc.\\n    */\\n    int64 systemTotalSizeBytes = 10;\\n\\n    /**\\n     * The available memory on the system.  This number should not\\n     * be considered absolute: due to the nature of the kernel, a significant\\n     * portion of this memory is actually in use and needed for the overall\\n     * system to run well.\\n     */\\n    int64 systemAvailableSizeBytes = 11;\\n\\n    /**\\n     * The threshold of {@link #availMem} at which we consider memory to be\\n     * low and start killing background services and other non-extraneous\\n     * processes.\\n     */\\n    int64 systemThresholdSizeBytes = 12;\\n\\n    int32 relativeTime = 13;\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-protobuf:title=NetworkStats.proto\"\n  }), \"message NetworkStats {\\n\\n    /**\\n     * Return number of packets received by the given UID since device boot.\\n     * Counts packets across all network interfaces, and always increases\\n     * monotonically since device boot. Statistics are measured at the network\\n     * layer, so they include both TCP and UDP usage.\\n     * <p>\\n     * Before {@link android.os.Build.VERSION_CODES#JELLY_BEAN_MR2}, this may return\\n     * {@link #UNSUPPORTED} on devices where statistics aren't available.\\n     * <p>\\n     * Starting in {@link android.os.Build.VERSION_CODES#N} this will only\\n     * report traffic statistics for the calling UID. It will return\\n     * {@link #UNSUPPORTED} for all other UIDs for privacy reasons. To access\\n     * historical network statistics belonging to other UIDs, use\\n     * {@link NetworkStatsManager}.\\n     *\\n     * @see android.os.Process#myUid()\\n     * @see android.content.pm.ApplicationInfo#uid\\n     */\\n    int64 rxPackets = 1;\\n\\n    /**\\n     * Return number of packets transmitted by the given UID since device boot.\\n     * Counts packets across all network interfaces, and always increases\\n     * monotonically since device boot. Statistics are measured at the network\\n     * layer, so they include both TCP and UDP usage.\\n     * <p>\\n     * Before {@link android.os.Build.VERSION_CODES#JELLY_BEAN_MR2}, this may return\\n     * {@link #UNSUPPORTED} on devices where statistics aren't available.\\n     * <p>\\n     * Starting in {@link android.os.Build.VERSION_CODES#N} this will only\\n     * report traffic statistics for the calling UID. It will return\\n     * {@link #UNSUPPORTED} for all other UIDs for privacy reasons. To access\\n     * historical network statistics belonging to other UIDs, use\\n     * {@link NetworkStatsManager}.\\n     *\\n     * @see android.os.Process#myUid()\\n     * @see android.content.pm.ApplicationInfo#uid\\n     */\\n    int64 txPackets = 2;\\n\\n    /**\\n     * Return number of bytes transmitted by the given UID since device boot.\\n     * Counts packets across all network interfaces, and always increases\\n     * monotonically since device boot. Statistics are measured at the network\\n     * layer, so they include both TCP and UDP usage.\\n     * <p>\\n     * Before {@link android.os.Build.VERSION_CODES#JELLY_BEAN_MR2}, this may\\n     * return {@link #UNSUPPORTED} on devices where statistics aren't available.\\n     * <p>\\n     * Starting in {@link android.os.Build.VERSION_CODES#N} this will only\\n     * report traffic statistics for the calling UID. It will return\\n     * {@link #UNSUPPORTED} for all other UIDs for privacy reasons. To access\\n     * historical network statistics belonging to other UIDs, use\\n     * {@link NetworkStatsManager}.\\n     *\\n     * @see android.os.Process#myUid()\\n     * @see android.content.pm.ApplicationInfo#uid\\n     */\\n    int64 txBytes = 3;\\n\\n    /**\\n     * Return number of bytes received by the given UID since device boot.\\n     * Counts packets across all network interfaces, and always increases\\n     * monotonically since device boot. Statistics are measured at the network\\n     * layer, so they include both TCP and UDP usage.\\n     * <p>\\n     * Before {@link android.os.Build.VERSION_CODES#JELLY_BEAN_MR2}, this may return\\n     * {@link #UNSUPPORTED} on devices where statistics aren't available.\\n     * <p>\\n     * Starting in {@link android.os.Build.VERSION_CODES#N} this will only\\n     * report traffic statistics for the calling UID. It will return\\n     * {@link #UNSUPPORTED} for all other UIDs for privacy reasons. To access\\n     * historical network statistics belonging to other UIDs, use\\n     * {@link NetworkStatsManager}.\\n     *\\n     * @see android.os.Process#myUid()\\n     * @see android.content.pm.ApplicationInfo#uid\\n     */\\n    int64 rxBytes = 4;\\n\\n    int32 relativeTime = 5;\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-protobuf:title=ResourceUsageStats.proto\"\n  }), \"message ResourceUsageStats {\\n\\n    int32 audioCount = 1;\\n    int64 audioTimeMillis = 2;\\n    int32 videoCount = 3;\\n    int64 videoTimeMillis = 4;\\n    int32 vibratorCount = 5;\\n    int64 vibratorTimeMillis = 6;\\n    int32 gpsSensorCount = 7;\\n    int64 gpsSensorTimeMillis = 8;\\n    int32 bluetoothCount = 9;\\n    int64 bluetoothTimeMillis = 10;\\n    int32 cameraCount = 11;\\n    int64 cameraTimeMillis = 12;\\n    int32 flashlightCount = 13;\\n    int64 flashlightTimeMillis = 14;\\n    int32 wifiScanCount = 15;\\n    int64 wifiScanTimeMillis = 16;\\n    int32 mobileRadioActiveCount = 17;\\n    int64 mobileRadioActiveTimeMillis = 18;\\n\\n    int64 wifiMultiCastMillis = 19;\\n    int64 bluetoothRxBytes = 20;\\n    int64 bluetoothTxBytes = 21;\\n    int64 bluetoothRxPackets = 22;\\n    int64 bluetoothTxPackets = 23;\\n\\n    /**\\n     * Key for a measurement of number of millseconds the wifi controller was\\n     * idle but turned on on behalf of this uid.\\n     */\\n    int64 wifiIdleMillis = 31;\\n\\n    /**\\n     * Key for a measurement of number of millseconds the bluetooth controller was\\n     * idle but turned on on behalf of this uid.\\n     */\\n    int64 bluetoothIdleMillis = 33;\\n\\n    /**\\n     * Key for a measurement of number of millseconds the mobile radio controller was\\n     * idle but turned on on behalf of this uid.\\n     */\\n    int64 mobileIdleMillis = 35;\\n\\n    /**\\n     * Key for a measurement of the estimated number of mA*ms used by this uid\\n     * for wifi, that is to say the number of milliseconds of wifi activity\\n     * times the mA current during that period.\\n     */\\n    int64 wifiPowerMams = 32;\\n\\n    /**\\n    * Key for a measurement of the estimated number of mA*ms used by this uid\\n    * for bluetooth, that is to say the number of milliseconds of activity\\n    * times the mA current during that period.\\n    */\\n    int64 bluetoothPowerMams = 34;\\n\\n    /**\\n     * Key for a measurement of the estimated number of mA*ms used by this uid\\n     * for mobile data, that is to say the number of milliseconds of activity\\n     * times the mA current during that period.\\n     */\\n    int64 mobilePowerMams = 36;\\n\\n    /**\\n     * Key for a measurement of number of millseconds the wifi controller was\\n     * active on behalf of this uid.\\n     */\\n    int64 wifiRunningMs = 37;\\n\\n    /**\\n     * Key for a measurement of number of millseconds that this uid held a full wifi lock.\\n     */\\n    int64 wifiFullLockMs = 38;\\n\\n    map<string, Timer> jobs = 24;\\n    map<string, Timer> sensors = 25;\\n    map<string, Timer> syncs = 26;\\n    map<string, Timer> wakeLocksDraw = 27;\\n    map<string, Timer> wakeLocksFull = 28;\\n    map<string, Timer> wakeLocksPartial = 29;\\n    map<string, Timer> wakeLocksWindow = 30;\\n\\n    int32 relativeTime = 39;\\n\\n    message Timer {\\n        int32 count = 1;\\n        int64 timeMillis = 2;\\n    }\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-protobuf:title=StorageStats.proto\"\n  }), \"message StorageStats {\\n\\n    Info internalStorage = 1;\\n\\n    repeated Info externalStorage = 2;\\n\\n    message Info {\\n        int64 totalSizeBytes = 1;\\n        int64 availableSizeBytes = 2;\\n    }\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-protobuf:title=ThreadStats.proto\"\n  }), \"message ThreadStats {\\n\\n    repeated ThreadInfo threadsInfo = 2;\\n\\n    int32 relativeTime = 3;\\n\\n    message ThreadInfo {\\n\\n        int64 id = 1;\\n\\n        string name = 2;\\n\\n        int32 priority = 3;\\n\\n        bool isInterrupted = 4;\\n\\n        bool isAlive = 5;\\n\\n        bool isDaemon = 6;\\n\\n        State state = 7;\\n    }\\n\\n    /**\\n     * A thread state.  A thread can be in one of the following states:\\n     * <ul>\\n     * <li>{@link #NEW}<br>\\n     *     A thread that has not yet started is in this state.\\n     *     </li>\\n     * <li>{@link #RUNNABLE}<br>\\n     *     A thread executing in the Java virtual machine is in this state.\\n     *     </li>\\n     * <li>{@link #BLOCKED}<br>\\n     *     A thread that is blocked waiting for a monitor lock\\n     *     is in this state.\\n     *     </li>\\n     * <li>{@link #WAITING}<br>\\n     *     A thread that is waiting indefinitely for another thread to\\n     *     perform a particular action is in this state.\\n     *     </li>\\n     * <li>{@link #TIMED_WAITING}<br>\\n     *     A thread that is waiting for another thread to perform an action\\n     *     for up to a specified waiting time is in this state.\\n     *     </li>\\n     * <li>{@link #TERMINATED}<br>\\n     *     A thread that has exited is in this state.\\n     *     </li>\\n     * </ul>\\n     *\\n     * <p>\\n     * A thread can be in only one state at a given point in time.\\n     * These states are virtual machine states which do not reflect\\n     * any operating system thread states.\\n     *\\n     * @since   1.5\\n     * @see #getState\\n     */\\n    enum State {\\n\\n        /**\\n         * Thread state for a thread which has not yet started.\\n         */\\n        NEW = 0;\\n\\n        /**\\n        * Thread state for a runnable thread.  A thread in the runnable\\n        * state is executing in the Java virtual machine but it may\\n        * be waiting for other resources from the operating system\\n        * such as processor.\\n        */\\n        RUNNABLE = 1;\\n\\n        /**\\n         * Thread state for a thread blocked waiting for a monitor lock.\\n         * A thread in the blocked state is waiting for a monitor lock\\n         * to enter a synchronized block/method or\\n         * reenter a synchronized block/method after calling\\n         * {@link Object#wait() Object.wait}.\\n         */\\n        BLOCKED = 2;\\n\\n        /**\\n         * Thread state for a waiting thread.\\n         * A thread is in the waiting state due to calling one of the\\n         * following methods:\\n         * <ul>\\n         *   <li>{@link Object#wait() Object.wait} with no timeout</li>\\n         *   <li>{@link #join() Thread.join} with no timeout</li>\\n         *   <li>{@link LockSupport#park() LockSupport.park}</li>\\n         * </ul>\\n         *\\n         * <p>A thread in the waiting state is waiting for another thread to\\n         * perform a particular action.\\n         *\\n         * For example, a thread that has called <tt>Object.wait()</tt>\\n         * on an object is waiting for another thread to call\\n         * <tt>Object.notify()</tt> or <tt>Object.notifyAll()</tt> on\\n         * that object. A thread that has called <tt>Thread.join()</tt>\\n         * is waiting for a specified thread to terminate.\\n         */\\n        WAITING = 3;\\n\\n        /**\\n         * Thread state for a waiting thread with a specified waiting time.\\n         * A thread is in the timed waiting state due to calling one of\\n         * the following methods with a specified positive waiting time:\\n         * <ul>\\n         *   <li>{@link #sleep Thread.sleep}</li>\\n         *   <li>{@link Object#wait(long) Object.wait} with timeout</li>\\n         *   <li>{@link #join(long) Thread.join} with timeout</li>\\n         *   <li>{@link LockSupport#parkNanos LockSupport.parkNanos}</li>\\n         *   <li>{@link LockSupport#parkUntil LockSupport.parkUntil}</li>\\n         * </ul>\\n         */\\n        TIMED_WAITING = 4;\\n\\n        /**\\n         * Thread state for a terminated thread.\\n         * The thread has completed execution.\\n         */\\n        TERMINATED = 5;\\n    }\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-protobuf:title=BinderStats.proto\"\n  }), \"message BinderStats {\\n\\n    int32 deathObjectCount = 1;\\n\\n    int32 localObjectCount = 2;\\n\\n    int32 proxyObjectCount = 3;\\n\\n    int32 receivedTransactions = 4;\\n\\n    int32 sentTransactions = 5;\\n\\n    int32 relativeTime = 6;\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-protobuf:title=FileIoStats.proto\"\n  }), \"message FileIoStats {\\n\\n    /* characters read\\n    * The number of bytes which this task has caused to be\\n    * read from storage.  This is simply the sum of bytes\\n    * which this process passed to read(2) and similar system\\n    * calls.  It includes things such as terminal I/O and is\\n    * unaffected by whether or not actual physical disk I/O\\n    * was required (the read might have been satisfied from\\n    * pagecache)\\n    */\\n    int64 charsReadBytes = 1;\\n\\n    /* characters written\\n    * The number of bytes which this task has caused, or\\n    * shall cause to be written to disk.  Similar caveats\\n    * apply here as with rchar.\\n    */\\n    int64 charsWriteBytes = 2;\\n\\n    /* read syscalls\\n    * Attempt to count the number of read I/O operations\\u2014that\\n    * is, system calls such as read(2) and pread(2)\\n    */\\n    int64 numSysReadCalls = 3;\\n\\n    /* write syscalls\\n    * Attempt to count the number of write I/O operations\\u2014\\n    * that is, system calls such as write(2) and pwrite(2).\\n    */\\n    int64 numSysWriteCalls = 4;\\n\\n    /* bytes read\\n    * Attempt to count the number of bytes which this process\\n    * really did cause to be fetched from the storage layer.\\n    * This is accurate for block-backed filesystems.\\n    */\\n    int64 readBytes = 5;\\n\\n    /* bytes written\\n    * Attempt to count the number of bytes which this process\\n    * caused to be sent to the storage layer.\\n    */\\n    int64 writeBytes = 6;\\n\\n    /*\\n    The big inaccuracy here is truncate.  If a process\\n    * writes 1MB to a file and then deletes the file, it will\\n    * in fact perform no writeout.  But it will have been\\n    * accounted as having caused 1MB of write.  In other\\n    * words: this field represents the number of bytes which\\n    * this process caused to not happen, by truncating page\\u2010\\n    * cache.  A task can cause \\\"negative\\\" I/O too.  If this\\n    * task truncates some dirty pagecache, some I/O which\\n    * another task has been accounted for (in its\\n    * write_bytes) will not be happening.\\n    */\\n    int64 cancelledWriteBytes = 7;\\n\\n    int32 relativeTime = 8;\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-protobuf:title=FrameStats.proto\"\n  }), \"message FrameStats {\\n\\n    string activityName = 1;\\n\\n    int64 animationDuration = 2;\\n\\n    int64 commandIssueDuration = 3;\\n\\n    int64 drawDuration = 4;\\n\\n    bool firstDrawFrame = 5;\\n\\n    int64 inputHandlingDuration = 6;\\n\\n    int64 layoutMeasureDuration = 7;\\n\\n    int64 swapBuffersDuration = 8;\\n\\n    int64 syncDuration = 9;\\n\\n    int64 totalDuration = 10;\\n\\n    int64 unknownDelayDuration = 11;\\n\\n    int64 intendedVSyncTimestamp = 12;\\n\\n    int64 vSyncTimestamp = 13;\\n\\n    int32 relativeTime = 14;\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-protobuf:title=GcStats.proto\"\n  }), \"message GcStats {\\n\\n    /** The number of garbage collection runs. */\\n    int32 runCount = 1;\\n\\n    /** The total duration of garbage collection runs in ms. */\\n    int32 runTotalDuration = 2;\\n\\n    /** The total number of bytes that the application allocated. */\\n    int64 totalBytesAllocated = 3;\\n\\n    /** The total number of bytes that garbage collection reclaimed. */\\n    int64 totalBytesFreed = 4;\\n\\n    /** The number of blocking garbage collection runs. */\\n    int32 blockingRunCount = 5;\\n\\n    /** The total duration of blocking garbage collection runs in ms. */\\n    int32 blockingRunTotalDuration = 6;\\n\\n    int32 relativeTime = 9;\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-protobuf:title=UnixProcessStats.proto\"\n  }), \"message UnixProcessStats {\\n\\n    /**\\n     *\\n     * One of the following characters, indicating process state:\\n     *\\n     *\\n     *  * 'R'  Running\\n     *  * 'S'  Sleeping in an interruptible wait\\n     *  * 'D'  Waiting in uninterruptible disk sleep\\n     *  * 'Z'  Zombie\\n     *  * 'T'  Stopped (on a signal) or (before Linux 2.6.33) trace stopped\\n     *  * 't'  Tracing stop (Linux 2.6.33 onward)\\n     *  * 'W'  Paging (only before Linux 2.6.0)\\n     *  * 'X'  Dead (from Linux 2.6.0 onward)\\n     *  * 'x'  Dead (Linux 2.6.33 to 3.13 only)\\n     *  * 'K'  Wakekill (Linux 2.6.33 to 3.13 only)\\n     *  * 'W'  Waking (Linux 2.6.33 to 3.13 only)\\n     *  * 'P'  Parked (Linux 3.9 to 3.13 only)\\n     *\\n     */\\n    string state = 1;\\n\\n    /**\\n    * The number of minor faults the process has made which have not required loading a memory\\n    * page from disk.\\n    */\\n    int64 numMinorFaults = 2;\\n\\n    /**\\n    * The number of minor faults that the process's waited-for children have made.\\n    */\\n    int64 numChildMinorFaults = 3;\\n\\n    /**\\n     * The number of major faults the process has made which have required loading a memory page\\n     * from disk.\\n     */\\n    int64 numMajorFaults = 4;\\n\\n    /**\\n     * The number of major faults that the process's waited-for children have made.\\n     */\\n    int64 numChildMajorFaults = 5;\\n\\n    /**\\n    * Amount of time that this process has been scheduled in user mode, measured in clock ticks\\n    * (divide by sysconf(_SC_CLK_TCK)).  This includes guest time, guest_time (time spent running\\n    * a virtual CPU, see below), so that applications that are not aware of the guest time field\\n    * do not lose that time from their calculations.\\n    */\\n    int64 userTime = 6;\\n\\n    /**\\n    * Amount of time that this process has been scheduled in kernel mode, measured in clock ticks\\n    * (divide by sysconf(_SC_CLK_TCK)).\\n    */\\n    int64 systemTime = 7;\\n\\n    /**\\n    * Amount of time that this process's waited-for children have been scheduled in user mode,\\n    * measured in clock ticks (divide by sysconf(_SC_CLK_TCK)). (See also times(2).)  This\\n    * includes guest time, cguest_time (time spent running a virtual CPU, see below).\\n    */\\n    int64 childUserTime = 8;\\n\\n    /**\\n    * Amount of time that this process's waited-for children have been scheduled in kernel mode,\\n    * measured in clock ticks (divide by sysconf(_SC_CLK_TCK)).\\n    */\\n    int64 childSystemTime = 9;\\n\\n    /**\\n     * Virtual memory size in bytes.\\n     */\\n    int64 virtualMemorySize = 10;\\n\\n    /**\\n    * Resident Set Size: number of pages the process has in real memory.  This is just the pages\\n    * which count toward text, data, or stack space.  This does not include pages which have not\\n    * been demand-loaded in, or which are swapped out.\\n    */\\n    int64 rss = 11;\\n\\n    /**\\n    * (since Linux 2.2.8)\\n    * CPU number last executed on.\\n    */\\n    int32 lastCpuExecutedNumber = 12;\\n\\n    /**\\n    * (since Linux 2.6.18)\\n    * Aggregated block I/O delays, measured in clock ticks (centiseconds).\\n    */\\n    int64 aggregatedBlockIoDelaysInTicks = 13;\\n\\n    int32 relativeTime = 14;\\n}\\n\")), mdx(\"h3\", null, \"6.1. \\uD83C\\uDF34 Logs\"), mdx(\"p\", null, \"The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"logcat\"), \" process is used to capture logs. The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"logcat\"), \" input stream is piped to a file on the TestServer's remote storage. While logcat can directly write to a file, it can't write to the TestServer's private directory.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kotlin:title=LogTunnel.kt\"\n  }), \"private const val CMD_CLEAR_LOGCAT_BUFFERS = \\\"logcat -b all -c\\\"\\nprivate const val CMD_START_LOGCAT = \\\"logcat -b all -v threadtime,epoch,printable --dividers\\\"\\n\\nclass LogTunnel {\\n\\n    fun start(sink: File) {\\n        Thread {\\n            getRuntime().exec(CMD_CLEAR_LOGCAT_BUFFERS)\\n            val logcat = getRuntime().exec(CMD_START_LOGCAT)\\n\\n            val sinkFileDescriptor = fileProvider.getAppendableFileDescriptor(sinkFileName)\\n            logcat.inputStream.pipe(sinkFileDescriptor)\\n        }.apply {\\n            name = \\\"LoggerThread\\\"\\n            start()\\n        }\\n    }\\n}\\n\")), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"This approach might be problematic if there is ever a need for external logs. Starting from Jellybean, the logs from external apps can't be read.\")), mdx(\"h3\", null, \"6.2. \\uD83D\\uDCF7 Screenshots\"), mdx(\"p\", null, \"Three strategies are employed to take a screenshot of the app:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://developer.android.com/reference/android/view/PixelCopy\"\n  }), \"PixelCopy\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Drawing the window decor view to a canvas. This strategy can't capture dialogs or other windows.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Using reflection to get all relevant windows and draw them to a canvas. This captures dialogs and other elements.\")), mdx(\"p\", null, \"The best strategy is picked and used during runtime.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-kt:title=ScreenShotterFactory.kt\"\n  }), \"class ScreenShotterFactory(\\n    private val screenshotHandler: Handler\\n) {\\n\\n    fun createOrderedBestShotters(): Set<ScreenShotter> {\\n        val shotters = mutableSetOf<ScreenShotter>()\\n\\n        if(AndroidVersion.isAtLeastOreo()) {\\n            shotters += WindowScreenShotter(screenshotHandler)\\n        }\\n\\n        shotters += ReflectionScreenShotter(screenshotHandler)\\n        shotters += RootViewScreenShotter(screenshotHandler)\\n        return shotters\\n    }\\n\\n    fun createBestShotter() = createOrderedBestShotters().first()\\n}\\n\")), mdx(\"h2\", null, \"7. \\uD83C\\uDFC3 Worker & WorkRunner\"), mdx(\"p\", null, \"The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"WorkRunner\"), \" sits at the heart of DART. Once the user clicks the start button, the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Worker\"), \" notifies the gRPC server that it is now available for work. The worker includes its current hardware and software states in the request. This information allows the gRPC server to match a worker to the right job at the right time. For instance, a worker won't receive work if it's hot.\"), mdx(\"p\", null, \"The work object contains details about the work to run and what configurations to use.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-protobuf:title=Work.proto\"\n  }), \"message Work {\\n    /**\\n     * Unique key of the given work.\\n     */\\n    string key = 1;\\n    string packageName = 18;\\n    string testPackageName = 19;\\n    /**\\n     * Type of the test being performed.\\n     */\\n    TestType type = 2;\\n    /**\\n     * The APK under test.\\n     */\\n    RemoteFile payload = 3;\\n    /**\\n     * The max time this test execution can run before it is cancelled (default: 15m).\\n     * It does not include any time necessary to prepare and clean up the target device.\\n     * The timeout unit is seconds. The maximum possible testing time is 1800 seconds.\\n     */\\n    int32 timeout = 4;\\n    /**\\n     * The locale is a two-letter (ISO 639-1) or three-letter (ISO 639-3) representation of the language.\\n     */\\n    string locale = 5;\\n    /**\\n     * The default orientation of the device.\\n     */\\n    ScreenOrientation orientation = 6;\\n\\n    /**\\n     * TODO: Update the comment\\n     * A comma-separated, key=value map of environment variables and their desired values. The environment variables are mirrored as extra options to the am instrument -e KEY1 VALUE1 \\u2026 command and passed to your test runner (typically AndroidJUnitRunner). Examples:\\n    Enable code coverage and provide a directory to store the coverage results when using Android Test Orchestrator (--use-orchestrator):\\n\\n    --environment-variables clearPackageData=true,coverage=true,coverageFilePath=/sdcard/\\n    Enable code coverage and provide a file path to store the coverage results when not using Android Test Orchestrator (--no-use-orchestrator):\\n\\n    --environment-variables coverage=true,coverageFile=/sdcard/coverage.ec\\n     */\\n    map<string, string> environmentVariables = 8;\\n\\n    /**\\n     * Specifies the number of times a test execution should be reattempted if one or more of its test cases fail for any reason. An execution that initially fails but succeeds on any reattempt is reported as FLAKY.\\n    The maximum number of reruns allowed is 10. (Default: 1, which implies one rerun.)\\n     */\\n    int32 numRetriesPerDevice = 9;\\n    int32 numTestRetries = 27;\\n\\n    /**\\n     * Monitor and record performance metrics: CPU, memory, and network usage. Enabled by default.\\n     */\\n    bool isPerformanceMonitoringEnabled = 10;\\n    stats.SampleFrequency sampleFrequency = 24;\\n\\n    /**\\n     * Enable video recording during the test. Enabled by default.\\n     */\\n    bool isVideoRecordingEnabled = 11;\\n    /**\\n     * The fully-qualified Java class name of the instrumentation test runner (default: the last name extracted from the APK manifest).\\n     */\\n    string testRunnerClassName = 12;\\n    /**\\n     * TODO: Update the comment and think of implementation\\n     * A list of one or more test target filters to apply (default: run all test targets).\\n     * Each target filter must be fully qualified with the package name, class name, or test annotation desired.\\n     * Any test filter supported by am instrument -e \\u2026 is supported. See https://developer.android.com/reference/android/support/test/runner/AndroidJUnitRunner for more information.\\n     * Examples:\\n    --test-targets \\\"package com.my.package.name\\\"\\n    --test-targets \\\"notPackage com.package.to.skip\\\"\\n    --test-targets \\\"class com.foo.ClassName\\\"\\n    --test-targets \\\"notClass com.foo.ClassName#testMethodToSkip\\\"\\n    --test-targets \\\"annotation com.foo.AnnotationToRun\\\"\\n    --test-targets \\\"size large notAnnotation com.foo.AnnotationToSkip\\\"\\n     */\\n    repeated string testTargets = 13;\\n    repeated tests.AtomicTest tests = 14;\\n\\n    /**\\n     * Whether each test runs in its own Instrumentation instance with the Android Test Orchestrator (default: Orchestrator is not used, same as specifying --no-use-orchestrator).\\n     * Orchestrator is only compatible with AndroidJUnitRunner v1.0 or higher.\\n     * See https://developer.android.com/training/testing/junit-runner.html#using-android-test-orchestrator for more information about Android Test Orchestrator.\\n     */\\n    bool isIsolated = 15;\\n    bool shouldClearPackageData = 16;\\n    bool obscureScreen = 17;\\n    bool takeWindowAutoShots = 20;\\n    bool retrieveAppFiles = 21;\\n    bool retrieveTestFiles = 22;\\n    bool useSystemProfiler = 23;\\n\\n    int32 autoScreenShotFps = 25;\\n    int32 autoScreenShotQuality = 26;\\n}\\n\\nmessage RemoteFile {\\n    string url = 1;\\n    int64 sizeBytes = 2;\\n    int64 lastModified = 3;\\n}\\n\\nenum TestType {\\n    INSTRUMENTATION = 0;\\n}\\n\\nenum ScreenOrientation {\\n    PORTRAIT = 0;\\n    LANDSCAPE = 1;\\n}\\n\")), mdx(\"h2\", null, \"8. \\u270D\\uFE0F Addendum\"), mdx(\"p\", null, \"The gRPC server is still in early development. Feel free to check out the Github repo.\"), mdx(\"p\", null, \"Hopefully, I was able to pique your interest in this topic. Please drop a comment if you have any questions.\"), mdx(\"h2\", null, \"9. \\uD83D\\uDCDA References\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://lilicoding.github.io/papers/kong2018automated.pdf\"\n  }), \"Automated Testing of Android Apps: A Systematic Literature Review\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://www.semanticscholar.org/paper/Maintenance-of-Android-Widget-Based-GUI-Testing%3A-A-Coppola-Morisio/87c08837fb583d4fc7e61678b9b5cf64bc45ca35\"\n  }), \"Maintenance of Android Widget-Based GUI Testing: A Taxonomy of Test Case Modification Causes\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://static.googleusercontent.com/media/www.android.com/en//static/2016/pdfs/enterprise/Android_Enterprise_Security_White_Paper_2019.pdf\"\n  }), \"Android Enterprise Security White Paper 2019\"))));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"There are currently ~2.5 billion Android devices — consisting of ~1,300 discrete brands and ~24,000 unique device models. I'm exploring…","timeToRead":9,"banner":{"childImageSharp":{"resize":{"src":"/static/499d2712e17282ad1d1b3a02691c82e2/73f08/banner.png"}}}}},"pageContext":{"slug":"/2020-11-23-building-distributed-android-remote-testing-platform/","formatString":"DD.MM.YYYY"}},"staticQueryHashes":["3090400250","3090400250","318001574"]}